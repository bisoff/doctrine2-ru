<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4-dev">
<meta name="author" content="В переводе: Alexey Plotnik">
<title>Doctrine2. Справочное руководство (Reference Guide)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary {
    display: block;
}

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video {
    display: inline-block;
}

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) {
    display: none;
    height: 0;
}

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template {
    display: none;
}

script {
    display: none !important;
}

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html {
    font-family: sans-serif; /* 1 */
    -ms-text-size-adjust: 100%; /* 2 */
    -webkit-text-size-adjust: 100%; /* 2 */
}

/** Remove default margin. */
body {
    margin: 0;
}

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a {
    background: transparent;
}

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus {
    outline: thin dotted;
}

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover {
    outline: 0;
}

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] {
    border-bottom: 1px dotted;
}

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong {
    font-weight: bold;
}

/** Address styling not present in Safari 5 and Chrome. */
dfn {
    font-style: italic;
}

/** Address differences between Firefox and other browsers. */
hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/** Address styling not present in IE 8/9. */
mark {
    background: #ff0;
    color: #000;
}

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp {
    font-family: monospace, serif;
    font-size: 1em;
}

/** Improve readability of pre-formatted text in all browsers. */
pre {
    white-space: pre-wrap;
}

/** Set consistent quote types. */
q {
    quotes: "\201C" "\201D" "\2018" "\2019";
}

/** Address inconsistent and variable font size in all browsers. */
small {
    font-size: 80%;
}

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img {
    border: 0;
}

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) {
    overflow: hidden;
}

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure {
    margin: 0;
}

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend {
    border: 0; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea {
    font-family: inherit; /* 1 */
    font-size: 100%; /* 2 */
    margin: 0; /* 3 */
}

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input {
    line-height: normal;
}

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select {
    text-transform: none;
}

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
}

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] {
    cursor: default;
}

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table {
    border-collapse: collapse;
    border-spacing: 0;
}

meta.foundation-mq-small {
    font-family: "only screen and (min-width: 768px)";
    width: 768px;
}

meta.foundation-mq-medium {
    font-family: "only screen and (min-width:1280px)";
    width: 1280px;
}

meta.foundation-mq-large {
    font-family: "only screen and (min-width:1440px)";
    width: 1440px;
}

*, *:before, *:after {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

html, body {
    font-size: 100%;
}

body {
    background: white;
    color: rgba(0, 0, 0, 0.8);
    padding: 0;
    margin: 0;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    position: relative;
    cursor: auto;
}

a:hover {
    cursor: pointer;
}

img, object, embed {
    max-width: 100%;
    height: auto;
}

object, embed {
    height: 100%;
}

img {
    -ms-interpolation-mode: bicubic;
}

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object {
    max-width: none !important;
}

.left {
    float: left !important;
}

.right {
    float: right !important;
}

.text-left {
    text-align: left !important;
}

.text-right {
    text-align: right !important;
}

.text-center {
    text-align: center !important;
}

.text-justify {
    text-align: justify !important;
}

.hide {
    display: none;
}

.antialiased, body {
    -webkit-font-smoothing: antialiased;
}

img {
    display: inline-block;
    vertical-align: middle;
}

textarea {
    height: auto;
    min-height: 50px;
}

select {
    width: 100%;
}

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: 1.21875em;
    line-height: 1.6;
}

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    line-height: 1.45;
    color: #7a2518;
    font-weight: normal;
    margin-top: 0;
    margin-bottom: 0.25em;
}

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td {
    margin: 0;
    padding: 0;
    direction: ltr;
}

/* Default Link Styles */
a {
    color: #2156a5;
    text-decoration: underline;
    line-height: inherit;
}

a:hover, a:focus {
    color: #1d4b8f;
}

a img {
    border: none;
}

/* Default paragraph styles */
p {
    font-family: inherit;
    font-weight: normal;
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    text-rendering: optimizeLegibility;
}

p aside {
    font-size: 0.875em;
    line-height: 1.35;
    font-style: italic;
}

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-weight: 300;
    font-style: normal;
    color: #ba3925;
    text-rendering: optimizeLegibility;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.0125em;
}

h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small {
    font-size: 60%;
    color: #e99b8f;
    line-height: 0;
}

h1 {
    font-size: 2.125em;
}

h2 {
    font-size: 1.6875em;
}

h3, #toctitle, .sidebarblock > .content > .title {
    font-size: 1.375em;
}

h4 {
    font-size: 1.125em;
}

h5 {
    font-size: 1.125em;
}

h6 {
    font-size: 1em;
}

hr {
    border: solid #ddddd8;
    border-width: 1px 0 0;
    clear: both;
    margin: 1.25em 0 1.1875em;
    height: 0;
}

/* Helpful Typography Defaults */
em, i {
    font-style: italic;
    line-height: inherit;
}

strong, b {
    font-weight: bold;
    line-height: inherit;
}

small {
    font-size: 60%;
    line-height: inherit;
}

code {
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace;
    font-weight: normal;
    color: rgba(0, 0, 0, 0.9);
}

/* Lists */
ul, ol, dl {
    font-size: 1em;
    line-height: 1.6;
    margin-bottom: 1.25em;
    list-style-position: outside;
    font-family: inherit;
}

ul, ol {
    margin-left: 1.5em;
}

ul.no-bullet, ol.no-bullet {
    margin-left: 1.5em;
}

/* Unordered Lists */
ul li ul, ul li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
    font-size: 1em; /* Override nested font-size change */
}

ul.square li ul, ul.circle li ul, ul.disc li ul {
    list-style: inherit;
}

ul.square {
    list-style-type: square;
}

ul.circle {
    list-style-type: circle;
}

ul.disc {
    list-style-type: disc;
}

ul.no-bullet {
    list-style: none;
}

/* Ordered Lists */
ol li ul, ol li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

/* Definition Lists */
dl dt {
    margin-bottom: 0.3125em;
    font-weight: bold;
}

dl dd {
    margin-bottom: 1.25em;
}

/* Abbreviations */
abbr, acronym {
    text-transform: uppercase;
    font-size: 90%;
    color: rgba(0, 0, 0, 0.8);
    border-bottom: 1px dotted #dddddd;
    cursor: help;
}

abbr {
    text-transform: none;
}

/* Blockquotes */
blockquote {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid #dddddd;
}

blockquote cite {
    display: block;
    font-size: 0.9375em;
    color: rgba(0, 0, 0, 0.6);
}

blockquote cite:before {
    content: "\2014 \0020";
}

blockquote cite a, blockquote cite a:visited {
    color: rgba(0, 0, 0, 0.6);
}

blockquote, blockquote p {
    line-height: 1.6;
    color: rgba(0, 0, 0, 0.85);
}

/* Microformats */
.vcard {
    display: inline-block;
    margin: 0 0 1.25em 0;
    border: 1px solid #dddddd;
    padding: 0.625em 0.75em;
}

.vcard li {
    margin: 0;
    display: block;
}

.vcard .fn {
    font-weight: bold;
    font-size: 0.9375em;
}

.vevent .summary {
    font-weight: bold;
}

.vevent abbr {
    cursor: auto;
    text-decoration: none;
    font-weight: bold;
    border: none;
    padding: 0 0.0625em;
}

@media only screen and (min-width: 768px) {
    h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
        line-height: 1.2;
    }

    h1 {
        font-size: 2.75em;
    }

    h2 {
        font-size: 2.3125em;
    }

    h3, #toctitle, .sidebarblock > .content > .title {
        font-size: 1.6875em;
    }

    h4 {
        font-size: 1.4375em;
    }
}

/* Tables */
table {
    background: white;
    margin-bottom: 1.25em;
    border: solid 1px #dedede;
}

table thead, table tfoot {
    background: #f7f8f7;
    font-weight: bold;
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
    padding: 0.5em 0.625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
    text-align: left;
}

table tr th, table tr td {
    padding: 0.5625em 0.625em;
    font-size: inherit;
    color: rgba(0, 0, 0, 0.8);
}

table tr.even, table tr.alt, table tr:nth-of-type(even) {
    background: #f8f8f7;
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
    display: table-cell;
    line-height: 1.6;
}

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    line-height: 1.2;
    word-spacing: -0.05em;
}

h1 strong, h2 strong, h3 strong, #toctitle strong, .sidebarblock > .content > .title strong, h4 strong, h5 strong, h6 strong {
    font-weight: 400;
}

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after {
    content: " ";
    display: table;
}

.clearfix:after, .float-group:after {
    clear: both;
}

*:not(pre) > code {
    font-size: 0.9375em;
    font-style: normal !important;
    letter-spacing: 0;
    padding: 0.1em 0.5ex;
    word-spacing: -0.15em;
    background-color: #f7f7f8;
    -webkit-border-radius: 4px;
    border-radius: 4px;
    line-height: 1.45;
    text-rendering: optimizeSpeed;
}

pre, pre > code {
    line-height: 1.45;
    color: rgba(0, 0, 0, 0.9);
    font-family: "Droid Sans Mono", "DejaVu Sans Mono", "Monospace", monospace;
    font-weight: normal;
    text-rendering: optimizeSpeed;
}

.keyseq {
    color: rgba(51, 51, 51, 0.8);
}

kbd {
    display: inline-block;
    color: rgba(0, 0, 0, 0.8);
    font-size: 0.75em;
    line-height: 1.4;
    background-color: #f7f7f7;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset;
    margin: -0.15em 0.15em 0 0.15em;
    padding: 0.2em 0.6em 0.2em 0.5em;
    vertical-align: middle;
    white-space: nowrap;
}

.keyseq kbd:first-child {
    margin-left: 0;
}

.keyseq kbd:last-child {
    margin-right: 0;
}

.menuseq, .menu {
    color: rgba(0, 0, 0, 0.8);
}

b.button:before, b.button:after {
    position: relative;
    top: -1px;
    font-weight: normal;
}

b.button:before {
    content: "[";
    padding: 0 3px 0 2px;
}

b.button:after {
    content: "]";
    padding: 0 2px 0 3px;
}

p a > code:hover {
    color: rgba(0, 0, 0, 0.9);
}

#header, #content, #footnotes, #footer {
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    margin-top: 0;
    margin-bottom: 0;
    max-width: 62.5em;
    *zoom: 1;
    position: relative;
    padding-left: 0.9375em;
    padding-right: 0.9375em;
}

#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after {
    content: " ";
    display: table;
}

#header:after, #content:after, #footnotes:after, #footer:after {
    clear: both;
}

#content {
    margin-top: 1.25em;
}

#content:before {
    content: none;
}

#header > h1:first-child {
    color: rgba(0, 0, 0, 0.85);
    margin-top: 2.25rem;
    margin-bottom: 0;
}

#header > h1:first-child + #toc {
    margin-top: 8px;
    border-top: 1px solid #ddddd8;
}

#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) {
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
}

#header .details {
    border-bottom: 1px solid #ddddd8;
    line-height: 1.45;
    padding-top: 0.25em;
    padding-bottom: 0.25em;
    padding-left: 0.25em;
    color: rgba(0, 0, 0, 0.6);
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -ms-flex-flow: row wrap;
    -webkit-flex-flow: row wrap;
    flex-flow: row wrap;
}

#header .details span:first-child {
    margin-left: -0.125em;
}

#header .details span.email a {
    color: rgba(0, 0, 0, 0.85);
}

#header .details br {
    display: none;
}

#header .details br + span:before {
    content: "\00a0\2013\00a0";
}

#header .details br + span.author:before {
    content: "\00a0\22c5\00a0";
    color: rgba(0, 0, 0, 0.85);
}

#header .details br + span#revremark:before {
    content: "\00a0|\00a0";
}

#header #revnumber {
    text-transform: capitalize;
}

#header #revnumber:after {
    content: "\00a0";
}

#content > h1:first-child:not([class]) {
    color: rgba(0, 0, 0, 0.85);
    border-bottom: 1px solid #ddddd8;
    padding-bottom: 8px;
    margin-top: 0;
    padding-top: 1rem;
    margin-bottom: 1.25rem;
}

#toc {
    border-bottom: 1px solid #efefed;
    padding-bottom: 0.5em;
}

#toc > ul {
    margin-left: 0.125em;
}

#toc ul.sectlevel0 > li > a {
    font-style: italic;
}

#toc ul.sectlevel0 ul.sectlevel1 {
    margin: 0.5em 0;
}

#toc ul {
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    list-style-type: none;
}

#toc a {
    text-decoration: none;
}

#toc a:active {
    text-decoration: underline;
}

#toctitle {
    color: #7a2518;
    font-size: 1.2em;
}

@media only screen and (min-width: 768px) {
    #toctitle {
        font-size: 1.375em;
    }

    body.toc2 {
        padding-left: 15em;
        padding-right: 0;
    }

    #toc.toc2 {
        margin-top: 0 !important;
        background-color: #f8f8f7;
        position: fixed;
        width: 15em;
        left: 0;
        top: 0;
        border-right: 1px solid #efefed;
        border-top-width: 0 !important;
        border-bottom-width: 0 !important;
        z-index: 1000;
        padding: 1.25em 1em;
        height: 100%;
        overflow: auto;
    }

    #toc.toc2 #toctitle {
        margin-top: 0;
        font-size: 1.2em;
    }

    #toc.toc2 > ul {
        font-size: 0.9em;
        margin-bottom: 0;
    }

    #toc.toc2 ul ul {
        margin-left: 0;
        padding-left: 1em;
    }

    #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
        padding-left: 0;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 15em;
    }

    body.toc2.toc-right #toc.toc2 {
        border-right-width: 0;
        border-left: 1px solid #efefed;
        left: auto;
        right: 0;
    }
}

@media only screen and (min-width: 1280px) {
    body.toc2 {
        padding-left: 20em;
        padding-right: 0;
    }

    #toc.toc2 {
        width: 20em;
    }

    #toc.toc2 #toctitle {
        font-size: 1.375em;
    }

    #toc.toc2 > ul {
        font-size: 0.95em;
    }

    #toc.toc2 ul ul {
        padding-left: 1.25em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 20em;
    }
}

#content #toc {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

#content #toc > :first-child {
    margin-top: 0;
}

#content #toc > :last-child {
    margin-bottom: 0;
}

#footer {
    max-width: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    padding: 1.25em;
}

#footer-text {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.44;
}

.sect1 {
    padding-bottom: 0.625em;
}

@media only screen and (min-width: 768px) {
    .sect1 {
        padding-bottom: 1.25em;
    }
}

.sect1 + .sect1 {
    border-top: 1px solid #efefed;
}

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor {
    position: absolute;
    z-index: 1001;
    width: 1.5ex;
    margin-left: -1.5ex;
    display: block;
    text-decoration: none !important;
    visibility: hidden;
    text-align: center;
    font-weight: normal;
}

#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before {
    content: "\00A7";
    font-size: 0.85em;
    display: block;
    padding-top: 0.1em;
}

#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover {
    visibility: visible;
}

#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link {
    color: #ba3925;
    text-decoration: none;
}

#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover {
    color: #a53221;
}

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock {
    margin-bottom: 1.25em;
}

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    text-rendering: optimizeLegibility;
    text-align: left;
    font-family: "Noto Serif", "DejaVu Serif", serif;
    font-size: 1rem;
    font-style: italic;
}

table.tableblock > caption.title {
    white-space: nowrap;
    overflow: visible;
    max-width: 0;
}

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    color: rgba(0, 0, 0, 0.85);
}

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: inherit;
}

.admonitionblock > table {
    border-collapse: separate;
    border: 0;
    background: none;
    width: 100%;
}

.admonitionblock > table td.icon {
    text-align: center;
    width: 80px;
}

.admonitionblock > table td.icon img {
    max-width: none;
}

.admonitionblock > table td.icon .title {
    font-weight: bold;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    text-transform: uppercase;
}

.admonitionblock > table td.content {
    padding-left: 1.125em;
    padding-right: 1.25em;
    border-left: 1px solid #ddddd8;
    color: rgba(0, 0, 0, 0.6);
}

.admonitionblock > table td.content > :last-child > :last-child {
    margin-bottom: 0;
}

.exampleblock > .content {
    border-style: solid;
    border-width: 1px;
    border-color: #e6e6e6;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: white;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.exampleblock > .content > :first-child {
    margin-top: 0;
}

.exampleblock > .content > :last-child {
    margin-bottom: 0;
}

.sidebarblock {
    border-style: solid;
    border-width: 1px;
    border-color: #e0e0dc;
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: #f8f8f7;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.sidebarblock > :first-child {
    margin-top: 0;
}

.sidebarblock > :last-child {
    margin-bottom: 0;
}

.sidebarblock > .content > .title {
    color: #7a2518;
    margin-top: 0;
    text-align: center;
}

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child {
    margin-bottom: 0;
}

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint {
    background: #f7f7f8;
}

.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint {
    background: #f2f1f1;
}

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
    -webkit-border-radius: 4px;
    border-radius: 4px;
    word-wrap: break-word;
    padding: 1em;
    font-size: 0.8125em;
}

.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap {
    overflow-x: auto;
    white-space: pre;
    word-wrap: normal;
}

@media only screen and (min-width: 768px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 0.90625em;
    }
}

@media only screen and (min-width: 1280px) {
    .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] {
        font-size: 1em;
    }
}

.literalblock.output pre {
    color: #f7f7f8;
    background-color: rgba(0, 0, 0, 0.9);
}

.listingblock pre.highlightjs {
    padding: 0;
}

.listingblock pre.highlightjs > code {
    padding: 1em;
    -webkit-border-radius: 4px;
    border-radius: 4px;
}

.listingblock pre.prettyprint {
    border-width: 0;
}

.listingblock > .content {
    position: relative;
}

.listingblock code[data-lang]:before {
    display: none;
    content: attr(data-lang);
    position: absolute;
    font-size: 0.75em;
    top: 0.425rem;
    right: 0.5rem;
    line-height: 1;
    text-transform: uppercase;
    color: #999;
}

.listingblock:hover code[data-lang]:before {
    display: block;
}

.listingblock.terminal pre .command:before {
    content: attr(data-prompt);
    padding-right: 0.5em;
    color: #999;
}

.listingblock.terminal pre .command:not([data-prompt]):before {
    content: "$";
}

table.pyhltable {
    border-collapse: separate;
    border: 0;
    margin-bottom: 0;
    background: none;
}

table.pyhltable td {
    vertical-align: top;
    padding-top: 0;
    padding-bottom: 0;
}

table.pyhltable td.code {
    padding-left: .75em;
    padding-right: 0;
}

pre.pygments .lineno, table.pyhltable td:not(.code) {
    color: #999;
    padding-left: 0;
    padding-right: .5em;
    border-right: 1px solid #ddddd8;
}

pre.pygments .lineno {
    display: inline-block;
    margin-right: .25em;
}

table.pyhltable .linenodiv {
    background: none !important;
    padding-right: 0 !important;
}

.quoteblock {
    margin: 0 1em 1.25em 1.5em;
    display: table;
}

.quoteblock > .title {
    margin-left: -1.5em;
    margin-bottom: 0.75em;
}

.quoteblock blockquote, .quoteblock blockquote p {
    color: rgba(0, 0, 0, 0.85);
    font-size: 1.15rem;
    line-height: 1.75;
    word-spacing: 0.1em;
    letter-spacing: 0;
    font-style: italic;
    text-align: justify;
}

.quoteblock blockquote {
    margin: 0;
    padding: 0;
    border: 0;
}

.quoteblock blockquote:before {
    content: "\201c";
    float: left;
    font-size: 2.75em;
    font-weight: bold;
    line-height: 0.6em;
    margin-left: -0.6em;
    color: #7a2518;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.quoteblock blockquote > .paragraph:last-child p {
    margin-bottom: 0;
}

.quoteblock .attribution {
    margin-top: 0.5em;
    margin-right: 0.5ex;
    text-align: right;
}

.quoteblock .quoteblock {
    margin-left: 0;
    margin-right: 0;
    padding: 0.5em 0;
    border-left: 3px solid rgba(0, 0, 0, 0.6);
}

.quoteblock .quoteblock blockquote {
    padding: 0 0 0 0.75em;
}

.quoteblock .quoteblock blockquote:before {
    display: none;
}

.verseblock {
    margin: 0 1em 1.25em 1em;
}

.verseblock pre {
    font-family: "Open Sans", "DejaVu Sans", sans;
    font-size: 1.15rem;
    color: rgba(0, 0, 0, 0.85);
    font-weight: 300;
    text-rendering: optimizeLegibility;
}

.verseblock pre strong {
    font-weight: 400;
}

.verseblock .attribution {
    margin-top: 1.25rem;
    margin-left: 0.5ex;
}

.quoteblock .attribution, .verseblock .attribution {
    font-size: 0.9375em;
    line-height: 1.45;
    font-style: italic;
}

.quoteblock .attribution br, .verseblock .attribution br {
    display: none;
}

.quoteblock .attribution cite, .verseblock .attribution cite {
    display: block;
    letter-spacing: -0.05em;
    color: rgba(0, 0, 0, 0.6);
}

.quoteblock.abstract {
    margin: 0 0 1.25em 0;
    display: block;
}

.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p {
    text-align: left;
    word-spacing: 0;
}

.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before {
    display: none;
}

table.tableblock {
    max-width: 100%;
    border-collapse: separate;
}

table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child {
    margin-bottom: 0;
}

table.spread {
    width: 100%;
}

table.tableblock, th.tableblock, td.tableblock {
    border: 0 solid #dedede;
}

table.grid-all th.tableblock, table.grid-all td.tableblock {
    border-width: 0 1px 1px 0;
}

table.grid-all tfoot > tr > th.tableblock, table.grid-all tfoot > tr > td.tableblock {
    border-width: 1px 1px 0 0;
}

table.grid-cols th.tableblock, table.grid-cols td.tableblock {
    border-width: 0 1px 0 0;
}

table.grid-all * > tr > .tableblock:last-child, table.grid-cols * > tr > .tableblock:last-child {
    border-right-width: 0;
}

table.grid-rows th.tableblock, table.grid-rows td.tableblock {
    border-width: 0 0 1px 0;
}

table.grid-all tbody > tr:last-child > th.tableblock, table.grid-all tbody > tr:last-child > td.tableblock, table.grid-all thead:last-child > tr > th.tableblock, table.grid-rows tbody > tr:last-child > th.tableblock, table.grid-rows tbody > tr:last-child > td.tableblock, table.grid-rows thead:last-child > tr > th.tableblock {
    border-bottom-width: 0;
}

table.grid-rows tfoot > tr > th.tableblock, table.grid-rows tfoot > tr > td.tableblock {
    border-width: 1px 0 0 0;
}

table.frame-all {
    border-width: 1px;
}

table.frame-sides {
    border-width: 0 1px;
}

table.frame-topbot {
    border-width: 1px 0;
}

th.halign-left, td.halign-left {
    text-align: left;
}

th.halign-right, td.halign-right {
    text-align: right;
}

th.halign-center, td.halign-center {
    text-align: center;
}

th.valign-top, td.valign-top {
    vertical-align: top;
}

th.valign-bottom, td.valign-bottom {
    vertical-align: bottom;
}

th.valign-middle, td.valign-middle {
    vertical-align: middle;
}

table thead th, table tfoot th {
    font-weight: bold;
}

tbody tr th {
    display: table-cell;
    line-height: 1.6;
    background: #f7f8f7;
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
    color: rgba(0, 0, 0, 0.8);
    font-weight: bold;
}

p.tableblock > code:only-child {
    background: none;
    padding: 0;
}

p.tableblock {
    font-size: 1em;
}

td > div.verse {
    white-space: pre;
}

ol {
    margin-left: 1.75em;
}

ul li ol {
    margin-left: 1.5em;
}

dl dd {
    margin-left: 1.125em;
}

dl dd:last-child, dl dd:last-child > :last-child {
    margin-bottom: 0;
}

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist {
    margin-bottom: 0.625em;
}

ul.unstyled, ol.unnumbered, ul.checklist, ul.none {
    list-style-type: none;
}

ul.unstyled, ol.unnumbered, ul.checklist {
    margin-left: 0.625em;
}

ul.checklist li > p:first-child > .fa-check-square-o:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    margin-right: 0.25em;
}

ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    position: relative;
    top: 1px;
}

ul.inline {
    margin: 0 auto 0.625em auto;
    margin-left: -1.375em;
    margin-right: 0;
    padding: 0;
    list-style: none;
    overflow: hidden;
}

ul.inline > li {
    list-style: none;
    float: left;
    margin-left: 1.375em;
    display: block;
}

ul.inline > li > * {
    display: block;
}

.unstyled dl dt {
    font-weight: normal;
    font-style: normal;
}

ol.arabic {
    list-style-type: decimal;
}

ol.decimal {
    list-style-type: decimal-leading-zero;
}

ol.loweralpha {
    list-style-type: lower-alpha;
}

ol.upperalpha {
    list-style-type: upper-alpha;
}

ol.lowerroman {
    list-style-type: lower-roman;
}

ol.upperroman {
    list-style-type: upper-roman;
}

ol.lowergreek {
    list-style-type: lower-greek;
}

.hdlist > table, .colist > table {
    border: 0;
    background: none;
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
    background: none;
}

td.hdlist1 {
    padding-right: .75em;
    font-weight: bold;
}

td.hdlist1, td.hdlist2 {
    vertical-align: top;
}

.literalblock + .colist, .listingblock + .colist {
    margin-top: -0.5em;
}

.colist > table tr > td:first-of-type {
    padding: 0 0.75em;
    line-height: 1;
}

.colist > table tr > td:last-of-type {
    padding: 0.25em 0;
}

.thumb, .th {
    line-height: 0;
    display: inline-block;
    border: solid 4px white;
    -webkit-box-shadow: 0 0 0 1px #dddddd;
    box-shadow: 0 0 0 1px #dddddd;
}

.imageblock.left, .imageblock[style*="float: left"] {
    margin: 0.25em 0.625em 1.25em 0;
}

.imageblock.right, .imageblock[style*="float: right"] {
    margin: 0.25em 0 1.25em 0.625em;
}

.imageblock > .title {
    margin-bottom: 0;
}

.imageblock.thumb, .imageblock.th {
    border-width: 6px;
}

.imageblock.thumb > .title, .imageblock.th > .title {
    padding: 0 0.125em;
}

.image.left, .image.right {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
    display: inline-block;
    line-height: 0;
}

.image.left {
    margin-right: 0.625em;
}

.image.right {
    margin-left: 0.625em;
}

a.image {
    text-decoration: none;
}

span.footnote, span.footnoteref {
    vertical-align: super;
    font-size: 0.875em;
}

span.footnote a, span.footnoteref a {
    text-decoration: none;
}

span.footnote a:active, span.footnoteref a:active {
    text-decoration: underline;
}

#footnotes {
    padding-top: 0.75em;
    padding-bottom: 0.75em;
    margin-bottom: 0.625em;
}

#footnotes hr {
    width: 20%;
    min-width: 6.25em;
    margin: -.25em 0 .75em 0;
    border-width: 1px 0 0 0;
}

#footnotes .footnote {
    padding: 0 0.375em;
    line-height: 1.3;
    font-size: 0.875em;
    margin-left: 1.2em;
    text-indent: -1.2em;
    margin-bottom: .2em;
}

#footnotes .footnote a:first-of-type {
    font-weight: bold;
    text-decoration: none;
}

#footnotes .footnote:last-of-type {
    margin-bottom: 0;
}

#content #footnotes {
    margin-top: -0.625em;
    margin-bottom: 0;
    padding: 0.75em 0;
}

.gist .file-data > table {
    border: 0;
    background: #fff;
    width: 100%;
    margin-bottom: 0;
}

.gist .file-data > table td.line-data {
    width: 99%;
}

div.unbreakable {
    page-break-inside: avoid;
}

.big {
    font-size: larger;
}

.small {
    font-size: smaller;
}

.underline {
    text-decoration: underline;
}

.overline {
    text-decoration: overline;
}

.line-through {
    text-decoration: line-through;
}

.aqua {
    color: #00bfbf;
}

.aqua-background {
    background-color: #00fafa;
}

.black {
    color: black;
}

.black-background {
    background-color: black;
}

.blue {
    color: #0000bf;
}

.blue-background {
    background-color: #0000fa;
}

.fuchsia {
    color: #bf00bf;
}

.fuchsia-background {
    background-color: #fa00fa;
}

.gray {
    color: #606060;
}

.gray-background {
    background-color: #7d7d7d;
}

.green {
    color: #006000;
}

.green-background {
    background-color: #007d00;
}

.lime {
    color: #00bf00;
}

.lime-background {
    background-color: #00fa00;
}

.maroon {
    color: #600000;
}

.maroon-background {
    background-color: #7d0000;
}

.navy {
    color: #000060;
}

.navy-background {
    background-color: #00007d;
}

.olive {
    color: #606000;
}

.olive-background {
    background-color: #7d7d00;
}

.purple {
    color: #600060;
}

.purple-background {
    background-color: #7d007d;
}

.red {
    color: #bf0000;
}

.red-background {
    background-color: #fa0000;
}

.silver {
    color: #909090;
}

.silver-background {
    background-color: #bcbcbc;
}

.teal {
    color: #006060;
}

.teal-background {
    background-color: #007d7d;
}

.white {
    color: #bfbfbf;
}

.white-background {
    background-color: #fafafa;
}

.yellow {
    color: #bfbf00;
}

.yellow-background {
    background-color: #fafa00;
}

span.icon > .fa {
    cursor: default;
}

.admonitionblock td.icon [class^="fa icon-"] {
    font-size: 2.5em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    cursor: default;
}

.admonitionblock td.icon .icon-note:before {
    content: "\f05a";
    color: #19407c;
}

.admonitionblock td.icon .icon-tip:before {
    content: "\f0eb";
    text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8);
    color: #111;
}

.admonitionblock td.icon .icon-warning:before {
    content: "\f071";
    color: #bf6900;
}

.admonitionblock td.icon .icon-caution:before {
    content: "\f06d";
    color: #bf3400;
}

.admonitionblock td.icon .icon-important:before {
    content: "\f06a";
    color: #bf0000;
}

.conum[data-value] {
    display: inline-block;
    color: #fff !important;
    background-color: rgba(0, 0, 0, 0.8);
    -webkit-border-radius: 100px;
    border-radius: 100px;
    text-align: center;
    font-size: 0.75em;
    width: 1.67em;
    height: 1.67em;
    line-height: 1.67em;
    font-family: "Open Sans", "DejaVu Sans", sans-serif;
    font-style: normal;
    font-weight: bold;
}

.conum[data-value] * {
    color: #fff !important;
}

.conum[data-value] + b {
    display: none;
}

.conum[data-value]:after {
    content: attr(data-value);
}

pre .conum[data-value] {
    position: relative;
    top: -0.125em;
}

b.conum * {
    color: inherit !important;
}

.conum:not([data-value]):empty {
    display: none;
}

h1, h2 {
    letter-spacing: -0.01em;
}

dt, th.tableblock, td.content {
    text-rendering: optimizeLegibility;
}

p, td.content {
    letter-spacing: -0.01em;
}

p strong, td.content strong {
    letter-spacing: -0.005em;
}

p, blockquote, dt, td.content {
    font-size: 1.0625rem;
}

p {
    margin-bottom: 1.25rem;
}

.sidebarblock p, .sidebarblock dt, .sidebarblock td.content, p.tableblock {
    font-size: 1em;
}

.exampleblock > .content {
    background-color: #fffef7;
    border-color: #e0e0dc;
    -webkit-box-shadow: 0 1px 4px #e0e0dc;
    box-shadow: 0 1px 4px #e0e0dc;
}

.print-only {
    display: none !important;
}

@media print {
    @page {
        margin: 1.25cm 0.75cm;
    }

    * {
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a {
        color: inherit !important;
        text-decoration: underline !important;
    }

    a.bare, a[href^="#"], a[href^="mailto:"] {
        text-decoration: none !important;
    }

    a[href^="http:"]:not(.bare):after, a[href^="https:"]:not(.bare):after, a[href^="mailto:"]:not(.bare):after {
        content: "(" attr(href) ")";
        display: inline-block;
        font-size: 0.875em;
        padding-left: 0.25em;
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    pre, blockquote, tr, img {
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group;
    }

    img {
        max-width: 100% !important;
    }

    p, blockquote, dt, td.content {
        font-size: 1em;
        orphans: 3;
        widows: 3;
    }

    h2, h3, #toctitle, .sidebarblock > .content > .title, #toctitle, .sidebarblock > .content > .title {
        page-break-after: avoid;
    }

    #toc, .sidebarblock, .exampleblock > .content {
        background: none !important;
    }

    #toc {
        border-bottom: 1px solid #ddddd8 !important;
        padding-bottom: 0 !important;
    }

    .sect1 {
        padding-bottom: 0 !important;
    }

    .sect1 + .sect1 {
        border: 0 !important;
    }

    #header > h1:first-child {
        margin-top: 1.25rem;
    }

    body.book #header {
        text-align: center;
    }

    body.book #header > h1:first-child {
        border: 0 !important;
        margin: 2.5em 0 1em 0;
    }

    body.book #header .details {
        border: 0 !important;
        display: block;
        padding: 0 !important;
    }

    body.book #header .details span:first-child {
        margin-left: 0 !important;
    }

    body.book #header .details br {
        display: block;
    }

    body.book #header .details br + span:before {
        content: none !important;
    }

    body.book #toc {
        border: 0 !important;
        text-align: left !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body.book #toc, body.book #preamble, body.book h1.sect0, body.book .sect1 > h2 {
        page-break-before: always;
    }

    .listingblock code[data-lang]:before {
        display: block;
    }

    #footer {
        background: none !important;
        padding: 0 0.9375em;
    }

    #footer-text {
        color: rgba(0, 0, 0, 0.6) !important;
        font-size: 0.9em;
    }

    .hide-on-print {
        display: none !important;
    }

    .print-only {
        display: block !important;
    }

    .hide-for-print {
        display: none !important;
    }

    .show-for-print {
        display: inherit !important;
    }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
</head>
<body class="book">
<div id="header">
<h1>Doctrine2. Справочное руководство (Reference Guide)</h1>
<div class="details">
<span id="author" class="author">В переводе: Alexey Plotnik</span><br>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="annotation"><a class="anchor" href="#annotation"></a>1. О переводе</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Автор перевода: <a href="https://github.com/odiszapc">Alexey Plotnik</a></p>
</div>
<div class="paragraph">
<p>Ссылка на <a href="http://odiszapc.ru/doctrine">авторский перевод</a></p>
</div>
<div class="paragraph">
<p>Ссылка на <a href="http://docs.doctrine-project.org/en/latest/#reference-guide">оригинальный 'Reference Guide' по последней версии doctrine (english)</a></p>
</div>
<div class="paragraph">
<p><em>ПРИМЕЧАНИЯ ПЕРЕВОДЧИКА:<br>
Когда я работал над переводом, в тексте основных глав документации по Doctrine мне неоднократно встречались термины, значение которых понятны лишь в контексте ORM, трактовать их можно по-разному. При прямом переводе без пояснений их смысл может быть утерян. Поэтому в разделе <a href="Глоссарий.asc">Глоссарий</a> я просто своими словами опишу, что по моему мнению они означают, чтобы вам было понятно о чем будет идти речь и не возникло проблем при чтении руководства.</em></p>
</div>
<div class="paragraph">
<p><em>ПРИМЕЧАНИЕ РЕДАКТОРА:<br>
Данная копипаста создана с целью выверки технологии для генерации pdf ebook из web-статей с помощью  стандарта разметки asciidoc и интсрумента AsciidocFX, который выполняет основную работу по автоматическому переформатированию HTML.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="glossary"><a class="anchor" href="#glossary"></a>2. Глоссарий</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Entity, Persistent classes</dt>
<dd>
<p>Сущность, хранимый (персистентный) класс. По сути одно и тоже. Основная концепция Doctrine. Сущностью может быть одна таблица, либо таблица со связанными с ней другими таблицами. Да что там, сущностью может быть целая база данных! Чтобы класс считался хранимым (то есть обрабатывался Доктриной) он должен быть помечен как сущность при помощи метаданных, например аннотацией к классу со свойством @Entity:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @Entity */
class Entity_MyItem
{
}</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Metadata, Оbject-relational mapping metadata</dt>
<dd>
<p>Метаданные. Набор параметров, описывающих как объектная модель будет проецироваться на физическую модель в базе данных. Эти директивы превращают обычный класс в сущность. Вы берете обычный класс, добавляете к нему метаданные и все — вот она ваша сущность. Метаданные могут быть определены тремя strong textспособами:</p>
<div class="ulist">
<ul>
<li>
<p>XML</p>
</li>
<li>
<p>YAML</p>
</li>
<li>
<p>Аннотации DocBlock (комментарии в PHP-коде)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Association</dt>
<dd>
<p>Ассоциация. Взаимосвязь. Связь. Отношение. У сущности кроме простых полей могут быть поля, олицетворяющие ее взаимосвязь с другими сущностями. Что-то вроде отношений в базах данных (собственно это они и есть, но покрытые слоем абстракции ORM). Я предпочитаю называть это просто связью. Это соединения между сущностями.</p>
</dd>
<dt class="hdlist1">Inverse/owning side</dt>
<dd>
<p>Владеющая (прямая) и обратная стороны связи. Что это значит? К примеру, у вас есть сущность “Новость” и есть сущность “Комментарий”. У одной новости может быть несколько комментариев, поэтому комментарий содержит в себе ссылку на новость (физически в базе данных есть соответствующее поле, вроде new_id). Как вы видите, это классический пример отношения “один ко многим”, где “один” это новость, а “многие” это комментарии. Комментарии однозначно связаны с новостью, поэтому они — сторона владельца или прямая сторона. Это позволяет из сущности комментария перейти к сущности новости. Обратная сторона связи позволяет из новости получить указатель на ее комментарии.</p>
</dd>
<dt class="hdlist1">Proxy classes</dt>
<dd>
<p>Классы прокси. Прокси. Классы-заглушки. Используются для ускорения.</p>
</dd>
<dt class="hdlist1">Persistent properties</dt>
<dd>
<p>Хранимые свойства. Хранимые члены. Свойства класса сущности, непосредственно имеющие отношения к базе данных. Именно они и олицетворяют сущность как таковую. Такие свойства помечены соответствующими тегами в аннотациях к ним.</p>
</dd>
<dt class="hdlist1">DiscriminatorColumn</dt>
<dd>
<p>Столбец дискриминатора. Столбец дискриминатора содержит значение, которое определяет, какому классу принадлежит каждая запись. Что это такое? Это пошло еще с Java Hibernate.
Например, рассмотрим таблицу Persons, которая содержит данные всех сотрудников компании. Некоторые лица являются служащими, а некоторые — менеджерами. Таблица Persons содержит столбец с именем EmployeeType, который имеет значение 1 для менеджеров и значение 2 для служащих; это и есть столбец дискриминатора. В этом случае можно создать подкласс служащих и заполнить класс только записями, которые имеют в столбце EmployeeType значение 2. Кроме того, можно удалить из каждого класса неприменимые столбцы.</p>
</dd>
<dt class="hdlist1">Schema-Tool</dt>
<dd>
<p>Инструмент для работы со схемой данных. Он перестраивает ее, удаляет, создает. Переводить не нужно.</p>
</dd>
<dt class="hdlist1">Mapping</dt>
<dd>
<p>Отображение. Соответствия. Основная концепция любой ORM. Отображение объектной структуры на модель базы данных.</p>
</dd>
<dt class="hdlist1">Hydration</dt>
<dd>
<p>Гидрация. Вменяемого перевода на русский нет. Процесс гидрации – это процедура преобразования результата SQL запроса в объектную модель. В этот момент создаются экземпляры сущностей, подключаются связи и так далее.</p>
</dd>
<dt class="hdlist1">Annotations</dt>
<dd>
<p>Аннотации.</p>
</dd>
<dt class="hdlist1">Metadata drivers</dt>
<dd>
<p>Драйвер метаданных. Управляют различными способами представления метаданных (XML, YAML, аннотации Dockblock).</p>
</dd>
<dt class="hdlist1">Metadata Cache</dt>
<dd>
<p>Кеш метаданных. Чтобы каждый раз не парсить метаданные.</p>
</dd>
<dt class="hdlist1">Query cache</dt>
<dd>
<p>Кеш запросов. Не то, что вы подумали. Он кеширует не результаты SQL запросов, а результат разбора запроса DQL.</p>
</dd>
<dt class="hdlist1">Collection</dt>
<dd>
<p>Коллекция, список. Используется в контексте отношений “один ко многим” и “многие ко многим”. Похожи на массив, но конечно более навороченная концепция.</p>
</dd>
<dt class="hdlist1">DQL</dt>
<dd>
<p>Язык запросов Doctrine. Чем-то похож на SQL. Не вижу смысла переводить аббревиатуру.</p>
</dd>
<dt class="hdlist1">Orphan removal</dt>
<dd>
<p>Переводится как “удаление объектов-сирот”. Технология каскадного удаления объектов, на которые потеряны ссылки. Пример с новостями и комментариями: комментарий связан с новостью, при удалении новости сам комментарий перестает иметь смысл (конечно если вы не решите иначе). Так вот данный подход позволяет удалить его автоматически, если связь содержащая такой комментарий была соответствующим образом настроена.</p>
</dd>
<dt class="hdlist1">Ass</dt>
<dd>
<p>Некоторые предложения по тексту глав вызывали именно такое определение, по этой причине я не смог их перевести, не обессудьте.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>3. Введение</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true-"><a class="anchor" href="#true-"></a>3.1. Начало</h3>
<div class="paragraph">
<p><em>Doctrine 2</em> представляет собой хороший пример механизма объектно-реляционного отображения (ORM) для <em>PHP 5.3+</em>, позволяющий работать с базой данных максимально прозрачно, где в качестве промежуточного слоя используются обычные объекты <em>PHP</em>. В качестве основы используется весьма мощный слой абстракции от базы данных (<em>DBAL</em>). Основная задача<em>ORM</em>&#8201;&#8212;&#8201;связать две концепции: объекты <em>PHP</em> и записи в реляционной базе данных.</p>
</div>
<div class="paragraph">
<p>Одна из ключевых особенностей Doctrine&#8201;&#8212;&#8201;возможность написания запросов на собственном объектно-ориентированном языке, чем-то напоминающим SQL, называемым <em>Doctrine Query Language (DQL)</em>, созданным под вдохновением от <em>Hibernates HQL</em>. Помимо небольших отличий от <em>SQL</em>, он позволяет значительно усилить степень абстракции между объектами и строками базы данных, что позволяет создавать мощные и гибкие запросы, при этом сохраняя целостность.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--2"><a class="anchor" href="#true--2"></a>3.2. Достоверность информации</h3>
<div class="paragraph">
<p>Данный документ представляет собой справочную документацию по <em>Doctrine 2</em>. Руководства для начинающих и обучалки, как это было для <em>Doctrine 1.x</em> будут доступны позднее.</p>
</div>
</div>
<div class="sect2">
<h3 id="true-orm"><a class="anchor" href="#true-orm"></a>3.3. Применение ORM</h3>
<div class="paragraph">
<p>Как уже было сказано, задача <em>Doctrine 2</em>&#8201;&#8212;&#8201;упростить взаимодействие между строками в СУБД и объектной моделью <em>PHP</em>. Так что основной эффект от ее применения может быть достигнут лишь в объектно-ориентированной среде и приложениях, использующих парадигму ООП. В остальных случаях от <em>Doctrine 2</em> будет мало пользы.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--3"><a class="anchor" href="#true--3"></a>3.4. Требования</h3>
<div class="paragraph">
<p><em>Doctrine 2</em> требуется версия <em>PHP</em> не менее <em>5.3.0</em>. Для увеличения производительность рекомендуется использовать модуль <em>APC</em>для <em>PHP</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="true-doctrine-2"><a class="anchor" href="#true-doctrine-2"></a>3.5. Составляющие Doctrine 2</h3>
<div class="paragraph">
<p><em>Doctrine 2</em> состоит из трех основных библиотек.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Common</em></p>
</li>
<li>
<p><em>DBAL</em> (включает в себя <em>Common</em>)</p>
</li>
<li>
<p><em>ORM</em> (включает в себя как <em>DBAL</em>, так и <em>Common</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Данное руководство в основном относится к пакету <em>ORM</em>, однако иногда будут затронуты и остальные два. Есть определенные причины, по которым <em>Doctrine</em> была разбита на несколько частей:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Декомпозиция библиотеки дает большую гибкости</p>
</li>
<li>
<p>Пакет <em>Common</em> можно использовать отдельно от пакетов <em>ORM</em> и <em>DBAL</em></p>
</li>
<li>
<p><em>DBAL</em> можно использовать отдельно от <em>ORM</em></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="true-common"><a class="anchor" href="#true-common"></a>3.5.1. Библиотека Common</h4>
<div class="paragraph">
<p>Этот пакет содержит несколько компонентов, которые не имеют никаких внешних зависимостей, в т.ч. и от PHP. В <em>Common</em> в качестве корневого пространства имен используется <strong>Doctrine\Common</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-dbal"><a class="anchor" href="#true-dbal"></a>3.5.2. Библиотека DBAL</h4>
<div class="paragraph">
<p><em>DBAL</em> содержит слой абстракции от БД, в качестве надстройки над библиотекой <em>PDO</em>, однако плотно на ней не завязана. Задача этого слоя&#8201;&#8212;&#8201;дать один общий API, который покрывает все различия между интерфейсами СУБД. В качестве корневого пространства имен для классов <em>DBAL</em> используется <strong>Doctrine\DBAL</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-orm-2"><a class="anchor" href="#true-orm-2"></a>3.5.3. Библиотека ORM</h4>
<div class="paragraph">
<p>Пакет <em>ORM</em> содержит в себе реализацию алгоритма объектно-реляционного отображения, реализуя прозрачные взаимосвязи и отношения для обычных <em>PHP</em> объектов. В <em>ORM</em> в качестве корневого пространства имен используется <strong>Doctrine\ORM</strong>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--4"><a class="anchor" href="#true--4"></a>3.6. Установка</h3>
<div class="paragraph">
<p>Существует несколько способов установки Doctrine. Ниже будут описаны все возможные варианты, так выбирайте какой вам больше нравится.</p>
</div>
<div class="sect3">
<h4 id="truepear"><a class="anchor" href="#truepear"></a>3.6.1. PEAR</h4>
<div class="paragraph">
<p>Все три части <em>Doctrine</em> можно легко установить из командной строки <em>PEAR</em>.</p>
</div>
<div class="paragraph">
<p>Установка только библиотеки <em>Common</em> осуществляется следующей командой:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo pear install pear.doctrine-project.org/DoctrineCommon-&lt;version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><em>DBAL</em> устанавливается так:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo pear install pear.doctrine-project.org/DoctrineDBAL-&lt;version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>А <em>ORM</em> так:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo pear install pear.doctrine-project.org/DoctrineORM-&lt;version&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Тэг <em>&lt;version&gt;</em> представляет собой номер версии, которую нужно установить. Например, если текущая версия <em>ORM 2.07</em>, то команда будет выглядеть так:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo pear install pear.doctrine-project.org/DoctrineORM-2.0.7</pre>
</div>
</div>
<div class="paragraph">
<p>Когда установка будет завершена, вам нужно будет подключить загрузчик классов <em>ClassLoader</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
require 'Doctrine/ORM/Tools/Setup.php';
Doctrine\ORM\Tools\Setup::registerAutoloadPEAR();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Все установленные библиотеки будут находится в корневой директории <em>PEAR</em> в подкаталоге <em>Doctrine/</em>. Помимо этого, вы получите в свое распоряжении небольшую утилиту командной строки, с ее помощью вы будете выполнять типовые задачи. Запустите команду <em>doctrine</em> без параметров, чтобы просмотреть доступные ключи запуска:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ doctrine
Doctrine Command Line Interface version 2.0.0BETA3-DEV

Usage:
  [options] command [arguments]

Options:
  --help -h Display this help message.
  --quiet -q Do not output any message.
  --verbose -v Increase verbosity of messages.
  --version -V Display this program version.
  --color -c Force ANSI color output.
  --no-interaction -n Do not ask any interactive question.

Available commands:
  help Displays help for a command (?)
  list Lists commands
dbal
  :import Import SQL file(s) directly to Database.
  :run-sql Executes arbitrary SQL directly from the command line.
orm
  :convert-d1-schema Converts Doctrine 1.X schema into a Doctrine 2.X schema.
  :convert-mapping Convert mapping information between supported formats.
  :ensure-production-settings Verify that Doctrine is properly configured for a production  environment.
  :generate-entities Generate entity classes and method stubs from your mapping information.
  :generate-proxies Generates proxy classes for entity classes.
  :generate-repositories Generate repository classes from your mapping information.
  :run-dql Executes arbitrary DQL directly from the command line.
  :validate-schema Validate that the mapping files.
orm:clear-cache
  :metadata Clear all metadata cache of the various cache drivers.
  :query Clear all query cache of the various cache drivers.
  :result Clear result cache of the various cache drivers.
orm:schema-tool
  :create Processes the schema and either create it directly on EntityManager Storage Connection or generate the SQL output.
  :drop Processes the schema and either drop the database schema of EntityManager Storage Connection or generate the SQL output.
  :update Processes the schema and either update the database schema of EntityManager Storage Connection or generate the SQL output.</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true--5"><a class="anchor" href="#true--5"></a>3.6.2. Загрузка с сайта</h4>
<div class="paragraph">
<p><em>Doctrine 2</em> можно также установить, скачав последнюю версию пакета со <a href="http://www.doctrine-project.org/downloads">страницы загрузки</a>.</p>
</div>
<div class="paragraph">
<p>Настройка и инициализация этой версии <em>Doctrine</em> описываются в разделе configuration[Настройка] данного руководства.</p>
</div>
</div>
<div class="sect3">
<h4 id="truegithub"><a class="anchor" href="#truegithub"></a>3.6.3. GitHub</h4>
<div class="paragraph">
<p>В качестве альтернативы можно загрузить последнюю версию Doctrine 2 с GitHub.com:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git clone git://github.com/doctrine/doctrine2.git doctrine</pre>
</div>
</div>
<div class="paragraph">
<p>Но, таким образом, у вас будут только исходные коды для пакета <em>ORM</em>. Для пакетов <em>Common</em> и <em>DBAL</em> нужно будет отдельно инициализировать дочерние модули:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git submodule init
$ git submodule update</pre>
</div>
</div>
<div class="paragraph">
<p>Этот финт обновит вашу рабочую копию для использования <em>Doctrine</em> и тех версий ее дочерних библиотек, которые подходят к клонированной master-ветви <em>Doctrine 2</em>.</p>
</div>
<div class="paragraph">
<p>В разделе <a href="http://odiszapc.ru/doctrine/configuration">Настройка</a> описано как настроить установленную с <em>Github</em> версию <em>Doctrine</em> для использования автозагрузки классов.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Не стоит пытаться совместно использовать модули Doctrine-Common, Doctrine-DBAL и Doctrine-ORM, полученные из основной ветви репозитория. ORM просто может не захотеть работать с текущими версиями Common и DBAL из основной ветви. Вместо этого используйте Git Submodules</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="truesubversion"><a class="anchor" href="#truesubversion"></a>3.6.4. Subversion</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Не рекомендуется использовать зеркала Subversion. Они предоставят доступ только к последнему коммиту основной ветви и не загрузят дочерние модули.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Если вы предпочитаете <em>Subversion</em>, код можно получить как и раньше с <em>GitHub.com</em> по протоколу <em>Subversion</em>:
$ svn co <a href="http://svn.github.com/doctrine/doctrine2.git" class="bare">http://svn.github.com/doctrine/doctrine2.git</a> doctrine2
Однако, так вы получите лишь основную ветвь <em>Doctrine 2</em>, без зависимых модулей <em>Common</em> и <em>DBAL</em>. Их вам придется получить самостоятельно, но тут есть риск столкнуться с несовместимостью версий разных master-ветвей этих библиотек, о чем уже было сказано ранее.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--6"><a class="anchor" href="#true--6"></a>3.7. Песочница</h3>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Песочница доступна только в версии Doctrine 2, полученной из репозитория GitHub либо в ближайшее время будет доступна в качестве отдельного пакета на <a href="http://www.doctrine-project.org/projects/orm/download">странице загрузки</a> (на сегодняшний день (11.02.12) отдельного пакета с песочницей нет на странице загрузки). Вы найдете ее в каталоге $root/tools/sandbox folder.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Песочница представляет собой настроенное и готовое к работе окружение для проведения разных экспериментов или с целью просто поиграться с <em>Doctrine 2</em>.</p>
</div>
<div class="sect3">
<h4 id="true--7"><a class="anchor" href="#true--7"></a>3.7.1. Обзор</h4>
<div class="paragraph">
<p>Каталог с песочницей имеет следующую структуру:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sandbox/
    Entities/
        Address.php
        User.php
    xml/
        Entities.Address.dcm.xml
        Entities.User.dcm.xml
    yaml/
        Entities.Address.dcm.yml
        Entities.User.dcm.yml
    cli-config.php
    doctrine
    doctrine.php
    index.php</pre>
</div>
</div>
<div class="paragraph">
<p>Ниже краткое описание того, какие директории и файлы за что отвечают:</p>
</div>
<div class="paragraph">
<p>В каталоге <em>Entities</em> будут располагаться классы ваших моделей-сущностей. В качестве примера там уже лежат две сущности.</p>
</div>
<div class="paragraph">
<p>В каталоге <em>xml</em> находятся описания сущностей в формате XML (если, конечно, вы предпочтете этот формат для их описания). Тут тоже есть два примера их использования.</p>
</div>
<div class="paragraph">
<p>Каталог <em>yaml</em>&#8201;&#8212;&#8201;то же самое, но для формата YAML.</p>
</div>
<div class="paragraph">
<p>Файл <em>cli-config.php</em> содержит код инициализации, необходимый для консольной утилиты.</p>
</div>
<div class="paragraph">
<p><em>doctrine/doctrine.php</em>&#8201;&#8212;&#8201;это утилита командной строки.</p>
</div>
<div class="paragraph">
<p>index.php&#8201;&#8212;&#8201;обычный индексный файл приложения на PHP, в котором используется <em>Doctrine 2</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--8"><a class="anchor" href="#true--8"></a>3.7.2. Небольшая обучалка</h4>
<div class="paragraph">
<p>Выполните следующую команду из директории <em>tools/sandbox</em>:
$ php doctrine orm:schema-tool:create
Creating database schema&#8230;&#8203; Database schema created successfully!
Еще раз взгляните на каталог <em>tools/sandbox</em>. Внутри появилась новая база данных <em>SQLite</em> под названием <em>database.sqlite</em>.</p>
</div>
<div class="paragraph">
<p>Откройте <em>index.php</em> и в самом низу добавьте несколько строк кода, что-то вроде этого:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
//... bootstrap stuff

## PUT YOUR TEST CODE BELOW

$user = new \Entities\User;
$user-&gt;setName('Garfield');
$em-&gt;persist($user);
$em-&gt;flush();

echo "User saved!";
Запустите _index.php_ через браузер или из командной строки. На экране появится строка “User saved!”.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь давайте заглянем в наше хранилище <em>SQLite</em>. Снова выполните команду из папки <em>tools/sandbox</em>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ php doctrine dbal:run-sql “select * from users”</pre>
</div>
</div>
<div class="paragraph">
<p>Результат выполнения:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>array(1) {
  [0]=&gt;
  array(2) {
    ["id"]=&gt;
    string(1) "1"
    ["name"]=&gt;
    string(8) "Garfield"
 }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Поздравляем, вы только что сохранили в базе <em>SQLite</em>  вашу первую сущность с автоматически сгенерированным ID.</p>
</div>
<div class="paragraph">
<p>Теперь внесите следующие правки в <em>index.php</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
//... bootstrap stuff

## PUT YOUR TEST CODE BELOW

$q = $em-&gt;createQuery('select u from Entities\User u where u.name = ?1');
$q-&gt;setParameter(1, 'Garfield');
$garfield = $q-&gt;getSingleResult();

echo "Hello " . $garfield-&gt;getName() . "!";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Вы создали свой первый <em>DQL</em>-запрос для получения из базы данных пользователя с именем ‘Garfield’. Безусловно, это можно было сделать и более простым способом, мы лишь хотели продемонстрировать сам <em>DQL</em>. Догадаетесь как это можно сделать проще?</p>
</div>
<div class="paragraph">
<p>Когда вы создаете новые классы моделей или изменяете существующе, можно перестроить схему базы данных с помощью двух последовательных команд: команды <strong>doctrine orm:schema-tool –drop</strong> для удаления базы (будьте внимательны) а затем <strong>doctrine orm:schema-tool –create</strong> для создание новой схемы.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>4. Архитектура</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true-doctrine"><a class="anchor" href="#true-doctrine"></a>4.1. Сущности Doctrine</h3>
<div class="paragraph">
<p>Сущность&#8201;&#8212;&#8201;легковесный хранимый в БД объект из предметной области вашего приложения. Сущностью может являться любой <em>PHP</em> объект, который обладает следующими особенностями:</p>
</div>
<div class="paragraph">
<p>Сущность не должна быть финальным (<em>final</em>) классом или иметь финальные методы.</p>
</div>
<div class="paragraph">
<p>Все хранимые свойства класса сущности должны быть либо закрытыми (<em>private</em>), либо защищенными (<em>protected</em>), в противном случае “ленивая загрузка” будет работать некорректно. О ленивой загрузке будет сказано позднее.</p>
</div>
<div class="paragraph">
<p>В классе сущности не должно быть метода <em>_clone,</em> либо определять его нужно с осторожностью.</p>
</div>
<div class="paragraph">
<p>То же самое касается метода <em>wakeup</em>. Постарайтесь вместо него использовать интерфейс <em>Serializable</em>.</p>
</div>
<div class="paragraph">
<p>Если две сущности связаны между собой наследованием (напрямую, либо косвенно), у них не должно быть свойств с одинаковыми именами. Так что, если, например, некая сущность <em>B</em> наследуется от сущности <em>A</em>, то у нее не должно быть свойства с теми же именами, которые уже есть в <em>A</em> (которые наследовалось от <em>A</em> к <em>B</em>).</p>
</div>
<div class="paragraph">
<p>В сущности нельзя использовать функцию <em>func_get_args()</em> для того, чтобы узнать параметры вызова. Сгенерированные классы прокси не поддерживают этот подход по причине проблем с производительностью, так что ваш код может работать некорректно.</p>
</div>
<div class="paragraph">
<p>Сущности поддерживают наследование, полиморфизм для своих связей и запросов. Сущностями могут быть как абстрактные, так и обычные классы. Сущности могут наследоваться как от других сущностей, так и от обычных классов. И, наоборот, обычный класс можно запросто наследовать от сущности.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Замечание по поводу конструкторов. Конструктор класса сущности будет вызван лишь когда вы сами конструируете экземпляр этого класса с помощью оператора <strong>new</strong>. Сама Doctrine никогда не вызывает конструкторы сущностей, так что можете использовать их для собственных задач и передавать им любые аргументы.</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="true--9"><a class="anchor" href="#true--9"></a>4.1.1. Возможные состояния сущностей</h4>
<div class="paragraph">
<p>Экземпляр определенной сущности может быть иметь из четырех возможных типов: <em>NEW</em>, <em>MANAGED</em>, <em>DETACHED</em> и <em>REMOVED</em>.<em>(перевод сознательно опущен)</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>NEW</em>. Сущность в этом состоянии пока не имеет своего постоянного идентификатора в хранилище, и пока никак не связана с менеджером сущностей (<em>EntityManager</em>) и компонентом <em>UnitOfWork</em> (например, она была только что создана оператором <em>new</em>).</p>
</li>
<li>
<p><em>MANAGED</em>. Существующая сущность со своим идентификатором, находящаяся под управление менеджера сущностей<em>EntityManager</em>.</p>
</li>
<li>
<p><em>DETACHED</em>. Сущность, идентификатор которой больше не связан с менеджером сущностей или компонентом <em>UnitOfWork</em>.</p>
</li>
<li>
<p><em>REMOVED</em>. Сущность со своим постоянным идентификатором, связанная с <em>EntityManager</em>, которая будет удалена из базы данных при завершении транзакции.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="true--10"><a class="anchor" href="#true--10"></a>4.1.2. Хранимые свойства сущности</h4>
<div class="paragraph">
<p>Текущее состояние сущности определяется специальными “хранимыми” членами ее экземпляра (они помечаются специальным образом). Доступ к таким переменным должен осуществляться только самими экземпляром объекта сущности с помощью ее методов и никак иначе. Доступ извне к таким полям должен быть закрыт. Обращаться снаружи к ним можно лишь через методы-члены экземпляра класса, например через методы-аксессоры (getter/setter) или другим подобным образом.</p>
</div>
<div class="paragraph">
<p>Поля-коллекции сущности должны быть определены в соответствии с интерфейсом <em>Doctrine\Common\Collections\Collection</em>. Типы коллекций можно использовать для инициализации полей и свойств пока сущность еще не сохранена в базе данных. После того как сущностью станет управляемой (<em>MANAGED</em>) или будет отсоединена (<em>DETACHED</em>), доступ к ней должен предоставляться через этот интерфейс.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--11"><a class="anchor" href="#true--11"></a>4.1.3. Сериализация сущностей</h4>
<div class="paragraph">
<p>Не рекомендуется использовать сериализацию сущностей, потому как это может породить определенные проблемы, по крайней мере пока она будет содержать ссылки на объекты “прокси” или находиться под управлением <em>EntityManager</em>. Если вы все же решите сериализовать или де-сериализовать сущность, которая все еще содержит ссылки на прокси-объекты, то могут появиться проблемы с приватными свойствами из-за технических ограничений. Прокси-объекты определяют метод <em>_sleep</em>, который не может вернуть имена приватных членов родительских классов. С другой стороны реализовывать интерфейс<em>Serializable</em> тоже не решение, потому что тут нас ждут потенциальные проблемы с циклическими ссылками (пока мы не нашли другого пути, так что если вы знаете больше, сообщите).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueentitymanager"><a class="anchor" href="#trueentitymanager"></a>4.2. EntityManager</h3>
<div class="paragraph">
<p>Класс <em>EntityManager</em>&#8201;&#8212;&#8201;центральное звено <em>ORM</em> в <em>Doctrine 2</em>. <em>EntityManager</em> позволяет управлять хранимыми объектами и запрашивать их из хранилища.</p>
</div>
<div class="sect3">
<h4 id="true--12"><a class="anchor" href="#true--12"></a>4.2.1. Модель отложенных транзакций</h4>
<div class="paragraph">
<p>В <em>EntityManager</em> и <em>UnitOfWork</em> применяется стратегия под названием “отложенные транзакции”, которая откладывает исполнение <em>SQL</em>-запросов до поры до времени, чтобы затем выполнить их максимально эффективно при завершении транзакции, таким образом, что все блокировки на запись смогут быть быстро освобождены. Представьте себе, что <em>Doctrine</em> это инструмент для синхронизации сущестующих объектов в памяти с базой данных, которая происходит последовательно и небольшиим порциями. Работайте с вашими объектами, изменяйте их, а когда закончите вызовите метод <em>EntityManager#flush()</em>и все изменения будут сохранены.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-unit-of-work"><a class="anchor" href="#true-unit-of-work"></a>4.2.2. Паттерн Unit of Work</h4>
<div class="paragraph">
<p>Внутри <em>EntityManager</em> используется механизм <em>UnitOfWork</em>, который представляет собой реализацию одноименного паттерна <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a>. Он отслеживает все изменения данных в процессе работы и сохраняет их при исполнении транзакции через метод вроде <em>flush()</em>. Врядли вам придется работать напрямую с <em>UnitOfWork</em>, в основном все задачи будут решаться через класс<em>EntityManager</em>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>5. Настройка</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="true--13"><a class="anchor" href="#true--13"></a>5.1. Начальная загрузка</h3>
<div class="paragraph">
<p>Инициализация <em>Doctrine</em> относительно проста и осуществляется в два этапа:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Убедиться, что <em>Doctrine</em> имеет доступ ко всем небходимые классам, которые могут использоваться в процессе работы.</p>
</li>
<li>
<p>Получить экземпляр класса <em>EntityManager</em>.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="true--14"><a class="anchor" href="#true--14"></a>5.1.1. Загрузка классов</h4>
<div class="paragraph">
<p>Давайте начнем с загрузки классов. Вот что нам нужно: настроить несколько загрузчиков (часто называемых “автозагрузчиками”) таким образом, чтобы <em>Doctrine</em> при необходимости смогла сама подгружать нужные классы. Пространство имен<em>Doctrine</em> содержит очень быстрый и легковесный загрузчик, который можно использовать не только для <em>Doctrine</em>, но и других библиотек, если они соответствуют таким требованиям: местоположение классов в дереве каталогов отображается на их именах и пространствах имен, при этом у этих классов должно быть одно общее корневое пространство имен.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Вы не обязаны использовать только один этот метод для загрузки классов Doctrine. Нет никакой разницы как именно будет загружен класс. Если желаете использовать другой загрузчик, или подключать класс вручную, пожалуйста. Аналогично, загрузчик <em>Doctrine</em> может применяться не только для нее самой, но и для других классов, именование которых соответствует описанным выше стандартам.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Ниже будут приведены несколько типичных конфигураций автозагрузчика для разных способов установки <em>Doctrine</em>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Для тестирования кода ниже, создайте какой-нибудь файл, наапример test.php.</p>
</div>
</blockquote>
</div>
<div class="sect4">
<h5 id="true-pear"><a class="anchor" href="#true-pear"></a>Установка с помощью PEAR</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
// test.php

require 'Doctrine/ORM/Tools/Setup.php';

Doctrine\ORM\Tools\Setup::registerAutoloadPEAR();</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true-tar"><a class="anchor" href="#true-tar"></a>Установка из TAR-архива</h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
// test.php
 require 'Doctrine/ORM/Tools/Setup.php';

$lib = "/path/to/doctrine2-orm/lib";
Doctrine\ORM\Tools\Setup::registerAutoloadDirectory($lib);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true-git"><a class="anchor" href="#true-git"></a>Установка из Git-репозитория</h5>
<div class="paragraph">
<p>Здесь подразумевается, что у вас есть все зависимые пакеты, их можно получить с помощью <em>git submodule update –init</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
// test.php
require 'Doctrine/ORM/Tools/Setup.php';

$lib = '/path/to/doctrine2-orm-root';
Doctrine\ORM\Tools\Setup::registerAutoloadGit($lib);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true-symfony"><a class="anchor" href="#true-symfony"></a>Дополнительные компоненты Symfony</h5>
<div class="paragraph">
<p>Три приведенных примера подразумевают и загрузку классов Symphony: <em>Symfony Console</em> и <em>YAML</em>, которые также могут понадобиться для <em>Doctrine 2</em>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="true-entitymanager"><a class="anchor" href="#true-entitymanager"></a>5.1.2. Получение экземпляра EntityManager</h4>
<div class="paragraph">
<p>Итак, с загрузкой классов закончили, теперь нужно создать экземпляр менеджера сущностей <em>EntityManager</em>. Именно через осуществляется вся основная работа в <em>ORM Doctrine</em>.</p>
</div>
<div class="paragraph">
<p>Для настройки <em>EntityManager</em> необходим экземпляр класса <em>Doctrine\ORM\Configuration</em> и параметры подключения к базе данных. Ниже показан возможный вариант настройки.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
use Doctrine\ORM\EntityManager,
Doctrine\ORM\Configuration;

// ...

if ($applicationMode == "development") {
    $cache = new \Doctrine\Common\Cache\ArrayCache;
} else {
    $cache = new \Doctrine\Common\Cache\ApcCache;
}

$config = new Configuration;
$config-&gt;setMetadataCacheImpl($cache);
$driverImpl = $config-&gt;newDefaultAnnotationDriver('/path/to/lib/MyProject/Entities');
$config-&gt;setMetadataDriverImpl($driverImpl);
$config-&gt;setQueryCacheImpl($cache);
$config-&gt;setProxyDir('/path/to/myproject/lib/MyProject/Proxies');
$config-&gt;setProxyNamespace('MyProject\Proxies');

if ($applicationMode == "development") {
    $config-&gt;setAutoGenerateProxyClasses(true);
} else {
    $config-&gt;setAutoGenerateProxyClasses(false);
}

$connectionOptions = array(
    'driver' =&gt; 'pdo_sqlite',
    'path' =&gt; 'database.sqlite'
);

$em = EntityManager::create($connectionOptions, $config);</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>При работе с <em>Doctrine</em> обязательно используйте метаданные и кэш запросов. <em>Doctrine</em>, к слову сказать, прекрасно оптимизирована для работы с кешем. Основные части <em>Doctrine</em>, которые оптимизированы в плане кеширования&#8201;&#8212;&#8201;это метаданные, описывающие отображения (кеш метаданных) и процесс преобразования <em>DQL</em> в <em>SQL</em> (кеш запросов). Для работы кеширования необходимо минимум памяти, при этом оно позволяет значительно повысить производительность. Помимо этого рекомендуется использовать кеширование с помощью инструментов вроде <em>APC</em>. Прежде всего, он закеширует ваш байт-код, что будет полезно при любом раскладе. Кроме того, он поставляет высокопроизводительное хранилище прямо в оперативной памяти, в котором можно держать кеши для метаданных и запросов.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="true--15"><a class="anchor" href="#true--15"></a>5.1.3. Быстрая настройка</h4>
<div class="paragraph">
<p>Пример выше&#8201;&#8212;&#8201;это полноценная настройка всех необходимых параметров <em>Doctrine</em>. Можно упростить этот этап, воспользовавшись одним из предопределенных методов конфигурирования:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
use Doctrine\ORM\Tools\Setup;
use Doctrine\ORM\EntityManager;

$paths = array("/path/to/entities-or-mapping-files");
$isDevMode = false;

$config = Setup::createAnnotationMetadataConfiguration($paths, $isDevMode);
$em = EntityManager::create($dbParams, $config);

// Или если вы используете YAML или XML
$config = Setup::createXMLMetadataConfiguration($paths, $isDevMode);
$config = Setup::createYAMLMetadataConfiguration($paths, $isDevMode);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Тут делается несколько предположений:</p>
</div>
<div class="paragraph">
<p>Если <em>$devMode</em> установлена в <em>TRUE</em>, в качестве механизма кеширования будет использован стандартный <em>ArrayCache</em>, а параметр  setAutoGenerateProxyClasses будет установлен в <em>TRUE</em> .</p>
</div>
<div class="paragraph">
<p>В противном случае, механизм кеширования выбирается в порядке перебора очереди: <em>APC</em>, <em>Xcache</em>, <em>Memcache_</em>(127.0.0.1:11211)<em>. _setAutoGenerateProxyClasses</em> в этом случае устанавливается в <em>FALSE</em>.</p>
</div>
<div class="paragraph">
<p>Если третий аргумент (<em>$proxyDir</em>) отсутствует, будет использован системный каталог для временных файлов.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--16"><a class="anchor" href="#true--16"></a>5.2. Параметры конфигурации</h3>
<div class="paragraph">
<p>Следующие разделы описывают все возможные параметры конфигурации экземпляра класса <em>Doctrine\ORM\Configuration</em>.</p>
</div>
<div class="sect3">
<h4 id="true--17"><a class="anchor" href="#true--17"></a>5.2.1. Каталог для прокси (* Обязательно *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setProxyDir($dir);
$config-&gt;getProxyDir();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Тут происходит установка и получение пути к директории, в которой будут храниться сгенерированные Доктриной прокси-классы. Более детальная информация о прокси-классах и их использовании в <em>Doctrine</em> приведена в разделе “Прокси-объекты” далее по тексту.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--18"><a class="anchor" href="#true--18"></a>5.2.2. Пространства имен для прокси (* Обязательно *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setProxyNamespace($namespace);
$config-&gt;getProxyNamespace();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь указывается какое пространство имен будет использовано для сгенерированных прокси-классов. Более подробное описание приведено в разделе, посвященном прокси-объектам.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--19"><a class="anchor" href="#true--19"></a>5.2.3. Драйвер метаданных (* Обязательно *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setMetadataDriverImpl($driver);
$config-&gt;getMetadataDriverImpl();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Код выше демонстрирует как определить какой вариант реализации драйвера метаданных будет использован для обработки метаданных в ваших классах.</p>
</div>
<div class="paragraph">
<p>Существует 4 разновидности их реализаций:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>_Doctrine\ORM\Mapping\Driver\AnnotationDriver
_Doctrine\ORM\Mapping\Driver\XmlDriver_
_Doctrine\ORM\Mapping\Driver\YamlDriver_
_Doctrine\ORM\Mapping\Driver\DriverChain_</pre>
</div>
</div>
<div class="paragraph">
<p>Во многих примерах к этому руководству используется <em>AnnotationDriver</em>. Для получения информации об использовании драйверов XML и YAML обратитесь к соответствующим разделам.</p>
</div>
<div class="paragraph">
<p>Драйвер, работающий с аннотациями настраивается с помощью фабричного метода класса <em>Doctrine\ORM\Configuration</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$driverImpl = $config-&gt;newDefaultAnnotationDriver('/path/to/lib/MyProject/Entities');
$config-&gt;setMetadataDriverImpl($driverImpl);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь необходимо указать путь к классам сущностей, иначе массовые операции над всеми сущностями, осуществляемые через консоль, не будут работать корректно. Все драйвера метаданных в качестве этого параметра  позволяют указать как одиночную директорию, так и список, это позволит одному единственному драйверу работать с несколькими директориями, в которых лежат сущности.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--20"><a class="anchor" href="#true--20"></a>5.2.4. Кеш метаданных (* Рекомендуется *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setMetadataCacheImpl($cache);
$config-&gt;getMetadataCacheImpl();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь устанавливается какой механизм будет использоваться для кеширования метаданных, т.е. всей той информации, что вы укажете в аннотациях, через <em>XML</em> или <em>YAML</em>, так что при каждом запросе ее не нужно будет заново парсить и обрабатывать, что весьма накладно. Какую бы реализацию вы не выбрали, она должна наследовать общий для всех интерфейс<em>Doctrine\Common\Cache\Cache</em>.</p>
</div>
<div class="paragraph">
<p>Кеширование метаданных очень полезная штука. Нет ни одной адекватной причины, чтобы непользоваться ею.</p>
</div>
<div class="paragraph">
<p>Для продакшн-среды рекомендуется использовать следующие механизмы кеширования:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>_Doctrine\Common\Cache\ApcCache_
_Doctrine\Common\Cache\MemcacheCache_
_Doctrine\Common\Cache\XcacheCache_</pre>
</div>
</div>
<div class="paragraph">
<p>В среде для разработки более предпочтителен <em>Doctrine\Common\Cache\ArrayCache</em>, которые будет постоянно перекешировать данные при каждом запросе.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--21"><a class="anchor" href="#true--21"></a>5.2.5. Кеш запросов (* Рекомендуется *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setQueryCacheImpl($cache);
$config-&gt;getQueryCacheImpl();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Здесь устанавливается возможная реализация механизма кеширования для <em>DQL</em>-запросов, т.е. для результата разбора самого выражения <em>DQL</em>, которое затем преобразуется в <em>SQL</em> и информацию о том, как обрабатывать набор <em>SQL</em> запросов. Обратите внимание, это не кеш запросов в обычном понимании этого слова, он не затрагивает результаты запроса, так что кеширование не приведет к искажению в данных как это иногда случается. Этот вид кеша создан чисто для оптимизации и не имеет побочных эффектов, кроме разве что небольшого потребления памяти при работе.</p>
</div>
<div class="paragraph">
<p>Как и для метаданных, крайне рекомендуется использовать кеш и для запросов.</p>
</div>
<div class="paragraph">
<p>На продакшне используйте эти три варианта:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>_Doctrine\Common\Cache\ApcCache_
_Doctrine\Common\Cache\MemcacheCache_
_Doctrine\Common\Cache\XcacheCache_</pre>
</div>
</div>
<div class="paragraph">
<p>При разработке проще использовать <em>Doctrine\Common\Cache\ArrayCache</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-sql"><a class="anchor" href="#true-sql"></a>5.2.6. Журналирование SQL-запросов (* Опционально *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setSQLLogger($logger);
$config-&gt;getSQLLogger();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Устанавливается регистратор для сохранения всех <em>SQL</em> запросов, исполняемых через <em>Doctrine</em>. Класс регистратора должен определять интерфейс <em>Doctrine\DBAL\Logging\SQLLogger</em>. Самый простой вариант реализации журнала находится в <em>Doctrine\DBAL\Logging\EchoSQLLogger</em>, он выводит логи на стандартный поток вывода с помощью <em>echo</em> и <em>var_dump</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--22"><a class="anchor" href="#true--22"></a>5.2.7. Автоматическое создание классов прокси (* Опционально *)</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setAutoGenerateProxyClasses($bool);
$config-&gt;getAutoGenerateProxyClasses();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Определяет, следует ли генерировать классы прокси автоматически во время выполнения скрипта. Если поставить <em>FALSE</em>, то классы нужно будет сгененрировать вручную консольной командой с ключом <em>generate-proxies</em>. В продакшн среде крайне рекомендуется отключить авто-генерацию.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-development-production"><a class="anchor" href="#true-development-production"></a>5.3. Конфигурация для development- и production- сред</h3>
<div class="paragraph">
<p>Инициализация <em>Doctrine 2</em> должна осуществляться двумя способами с использованием двух различных моделей исполнения. На продакшне лучше использовать <em>APC</em> или <em>Memcache</em>, которые имеют много преимуществ в плане производительности. Но при разработке это не совсем то, что нужно, потому что вам не избежать частых ошибок, например, когда вы обновили какую-то сущность, а кеш содержит устаревшие данные. Так что для разработки больше подойдет <em>ArrayCache</em>.</p>
</div>
<div class="paragraph">
<p>Помимо этого, на продакшне следует отключить авто-генерацию прокси классов, при разработке же, наоборот, оставить эту возможность. Включенная авто-генерации может негативно влиять на производительность, например, когда несколько прокси классов будут повторно генерироваться во время исполнения скрипта. В этом случае запросы к файловой системе могут даже больше сказаться на производительности, чем сами запросы к базе данных. Кроме того, прокси устанавливает блокировку на файл, что при выполнении нескольких параллельных запросов будет порождать “бутылочные горлышки” .</p>
</div>
</div>
<div class="sect2">
<h3 id="true--23"><a class="anchor" href="#true--23"></a>5.4. Параметры подключения</h3>
<div class="paragraph">
<p>Параметр <em>$connectionOptions</em>, передаваемый в качестве первого аргумента в метод <em>EntityManager::create()</em> может быть массивом либо экземпляром класса <em>Doctrine\DBAL\Connection</em>. Если был передан массив, он сразу же передается в фабричный метод <em>DBAL Doctrine\DBAL\DriverManager::getConnection()</em>. Конфигурация <em>DBAL</em> описана в соответствующем разделе.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--24"><a class="anchor" href="#true--24"></a>5.5. Объекты прокси</h3>
<div class="paragraph">
<p>Прокси&#8201;&#8212;&#8201;это объект, который может подставляться и использоваться вместо “реального”. С помощью прокси объекта можно незаметно добавить новый функционал к основному объекту, так что самому объекту об этом беспокоиться не нужно. В<em>Doctrine 2</em> объекты прокси используются для реализации некоторых функций, основная из которых&#8201;&#8212;&#8201;ленивая загрузка.</p>
</div>
<div class="paragraph">
<p>Прокси объекты с помощью ленивой загрузки помогают сохранить взаимосвязь между набором объектов, находящимся в памяти и остальными объектами, которые еще не были загружены. Это очень важное свойство, без которого на границах графа ваших объектов будут всегда находится как бы неполноценные объекты, с некоторым количеством оборванных связей.</p>
</div>
<div class="paragraph">
<p>В <em>Doctrine 2</em> используется вариация паттерна прокси, которая работает следующим образом: сначала генерируются классы, расширяющие ваши сущности, затем к ним добавляется возможность ленивой загрузки. После этого <em>Doctrine</em> при запросе основного объекта, может вернуть вместо него прокси-версию. Это происходит в двух случаях:</p>
</div>
<div class="sect3">
<h4 id="true--25"><a class="anchor" href="#true--25"></a>5.5.1. Прокси для ссылок</h4>
<div class="paragraph">
<p>С помощью метода <em>EntityManager#getReference($entityName, $identifier)</em> можно получить ссылку на сущность по заданному идентификатору без ее загрузки из базы данных. Это бывает полезно, например, в целях повышения производительности, когда нужно установить связь с сущностью, зная ее идентификатор. Вы можете просто сделать следующее:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
// $em это EntityManager, $cart это экземпляр класса MyProject\Model\Cart
// $itemId идентификатор товара, полученный откуда угодно
$item = $em-&gt;getReference('MyProject\Model\Item', $itemId);
$cart-&gt;addItem($item);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Смотрите, мы добавляем товар в корзину без его реальной загрузки из базы данных. Если мы вызовем какой-нибудь метод у нашего объекта <em>$item</em>, он будет полностью проинициализирован, его состояние обновится до актуального из базы данных, и это произойдет прозрачно, именно это и называется ленивой загрузкой <em>(lazy-loading)</em>. Здесь <em>$item</em> это не что иное как экземпляр прокси класса, который был сгенерирован для класса <em>Item</em>, но для вас это не должно иметь значения. Просто забейте, работа объектов прокси полностью прозрачна.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--26"><a class="anchor" href="#true--26"></a>5.5.2. Прокси для связей</h4>
<div class="paragraph">
<p>Второй случай, когда <em>Doctrine</em> использует прокси это при запросах на получение объектов. Всякий раз, когда вы запрашиваете объект, имеющий однозначную взаимосвязь с другим объектом, поддерживающим ленивую загрузку, и при этом не используете <em>JOIN</em>, <em>Doctrine</em> заменит все такие объекты их прокси аналогами. Как и остальные прокси объекты, они будут инициализированы при первой же попытке доступа к ним.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Использование соединений <em>JOIN</em> в <em>DQL</em> или <em>SQL</em>, подразумевает “жадную загрузку” всех взаимосвязей. Тем самым для такого запроса будет переопределен параметр <em>“fetch”</em>, установленный в отображении для связи.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="true--27"><a class="anchor" href="#true--27"></a>5.5.3. Генерация классов прокси</h4>
<div class="paragraph">
<p>Классы прокси можно сгенерировать либо вручную через консольную утилиту <em>Doctrine</em>, либо автоматически. Параметр конфигурации, отвечающий за это:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setAutoGenerateProxyClasses($bool);
$config-&gt;getAutoGenerateProxyClasses();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для большего удобства за параметр по умолчанию принято значение <em>TRUE</em>. Однако, на продакшене в целях повышения производительности лучше отключить эту возможность. Не делайте этого в процессе разработки, т.к. это может породить ошибки, связанные с невозможностью загрузки классов (они не будут найдены), либо загрузки устаревших классов. Например, вы добавили новый метод к сущности, а в прокси классе он пока отсутствует. Чтобы избежать этого, заранее сгенерируйте новые прокси через консоль:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ./doctrine orm:generate-proxies</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--28"><a class="anchor" href="#true--28"></a>5.6. Несколько источников метаданных</h3>
<div class="paragraph">
<p>При работе с различными компонентами с помощью <em>Doctrine 2</em>, вы можете применять два разных драйвера метаданных, например <em>XML</em> и <em>YAML</em>. У вас есть возможность объединить эти драйвера с помощью компонента <em>DriverChain</em> на основе пространств имен:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$chain = new DriverChain();
$chain-&gt;addDriver($xmlDriver, 'Doctrine\Tests\Models\Company');
$chain-&gt;addDriver($yamlDriver, 'Doctrine\Tests\ORM\Mapping');</code></pre>
</div>
</div>
<div class="paragraph">
<p>При этом загрузка определенного пространства имен возлагается на соответствующий драйвер. Драйвер пробегает по всем пространствам имен и ищет совпадения, сравнивая название класса сущности с этим пространством имен при помощью простого выражения <em>strpos() === 0</em>. Поэтому, если дочерние пространства имен используют иные реализации драйвера метаданных для обработки, сами драйвера нужно расположить в определенном порядке.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--29"><a class="anchor" href="#true--29"></a>5.7. Репозиторий по-умолчанию (* Опционально *)</h3>
<div class="paragraph">
<p>Устанавливает полное имя <em>(Fully-Qualified Class Name, FQCN)</em> для дочернего класса <em>EntityRepository</em>. Этот класс будет использован для всех сущностей, у которых отсутствует собственный класс репозитория.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$config-&gt;setDefaultRepositoryClassName($fqcn);
$config-&gt;getDefaultRepositoryClassName();</code></pre>
</div>
</div>
<div class="paragraph">
<p>По-умолчанию используется класс <em>Doctrine\ORM\EntityRepository</em>. Каждый класс репозитория необходимо наследовать от<em>EntityRepository</em>, иначе вы получите исключение типа <em>ORMException</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq"><a class="anchor" href="#faq"></a>6. Часто задаваемые вопросы</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Этот раздел постоянно пополняется. От вас приходит много вопросов, на многие из них мы не отвечаем, но помним о чем спрашивают чаще всего. Если у вас есть вопрос, подписывайтесь на рассылку или подключайтесь в <em>IRC</em> к каналу <em>#doctrine</em>.</p>
</div>
<div class="sect2">
<h3 id="true--30"><a class="anchor" href="#true--30"></a>6.1. Схема базы данных</h3>
<div class="sect3">
<h4 id="true-collation-mysql"><a class="anchor" href="#true-collation-mysql"></a>6.1.1. Как установить кодировку и COLLATION для таблиц MySQL?</h4>
<div class="paragraph">
<p>Кодировку нельзя установить через аннотации и файлы XML- или YAML- отображений. Для настройки базы на работу с определенной кодировкой нужно установить ее как кодировку по-умолчанию в конфигурации MySQL, либо указать эти параметры при создании таблиц. В этом случае они будут автоматически применяться ко всем создаваемым таблицам и столбцам.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--31"><a class="anchor" href="#true--31"></a>6.2. Классы сущностей</h3>
<div class="sect3">
<h4 id="true-null"><a class="anchor" href="#true-null"></a>6.2.1. Обращаюсь к переменной-члену, а мне возвращается значение NULL, что не так?</h4>
<div class="paragraph">
<p>Похоже вы объявили переменную как публичную (public), тем самым нарушив одно из ограничений, накладываемых на сущности. Для корректной работы объектов прокси хранимые переменные-члены у сущности должны быть объявлены как приватные или защищенные.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--32"><a class="anchor" href="#true--32"></a>6.2.2. Как добавить для столбца значение по умолчанию?</h4>
<div class="paragraph">
<p><em>Doctrine</em> не поддерживает установку значений по умолчанию для столбцов как это делает в язык SQL через ключевое слово<em>DEFAULT</em>. Однако, это и не нужно, просто используйте для этого языковыми конструкции PHP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">class User
{
    const STATUS_DISABLED = 0;
    const STATUS_ENABLED = 1;

    private $algorithm = "sha1";
    private $status = self:STATUS_DISABLED;
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--33"><a class="anchor" href="#true--33"></a>6.3. Отображения</h3>
<div class="sect3">
<h4 id="true-em-flush"><a class="anchor" href="#true-em-flush"></a>6.3.1. При выполнении $em&#8594;flush() появляются ошибки, связанные с нарушением уникальности данных</h4>
<div class="paragraph">
<p><em>Doctrine</em> не проверяет не добавляете ли вы в базу данных сущности с уже дублирующимися ключами <em>PRIMARY</em>, или не добавляете ли вы дважды  в коллекцию одну и ту же сущность. Если есть какие-то опасения на этот счет, всегда можно сделать соответствующую проверку перед вызовом <em>$em&#8594;flush()</em>.</p>
</div>
<div class="paragraph">
<p>В <a href="http://www.symfony.com/">Symfony2</a> для этого существует соответствующий компонент под названием _Unique Entity Validato_r.</p>
</div>
<div class="paragraph">
<p>Проверить содержит ли коллекция заданную сущность можно с помощью метода <em>$collection&#8594;contains($entity)</em>. Для коллекции с параметром <em>FETCH</em> равным <em>LAZY</em> этот метод просто инициализирует коллекцию, однако если <em>FETCH</em> равен <em>EXTRA_LAZY</em>, то для проверки принадлежности Doctrine выполнит <em>SQL</em>-запросы.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--34"><a class="anchor" href="#true--34"></a>6.4. Связи</h3>
<div class="sect3">
<h4 id="true-invalidargumentexception-a-new-entity-was-found-through-the-relationship"><a class="anchor" href="#true-invalidargumentexception-a-new-entity-was-found-through-the-relationship"></a>6.4.1. Мне выдается исключение InvalidArgumentException  с сообщением “A new entity was found through the relationship..”. Что не так?</h4>
<div class="paragraph">
<p>Это исключение выбрасывается при исполнении метода <em>EntityManager#flush()</em> в случае, если в общей схеме данных существует объект, содержащий ссылку на некоторый объект, неизвестный <em>Doctrine</em>. Чтобы было проще понять, представьте, например, что вы загрузили из базы данных сущность пользователя <em>(User)</em> со своим идентификатором, затем создали новый объект и привязали его к объекту <em>User</em> через одну из существующих у него взаимосвязей. Затем, если вы вызовете<em>EntityManager#flush()</em>, не сообщив об свежесозданном объекте <em>Doctrine</em> с помощью метода <em>EntityManager#persist($newObject)</em>, будет выброшено такое исключение.</p>
</div>
<div class="paragraph">
<p>Решить проблему можно двумя путями:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Предварительно вызвать метод <em>EntityManager#persist($newObject)</em> для вновь созданного объекта</p>
</li>
<li>
<p>Использовать свойство <em>cascade=persist</em> для связи, содержащей новый объект</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="true--35"><a class="anchor" href="#true--35"></a>6.4.2. Могу ли я как-то отфильтровать связанный с сущностью набор данных?</h4>
<div class="paragraph">
<p>Такой возможности нет ни в версии_ Doctrine 2.0_, ни в <em>2.1</em>. Для фильтрации набора сущностей лучше использовать возможности DQL.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-clear"><a class="anchor" href="#true-clear"></a>6.4.3. После вызова метода clear() на наборе типа “один ко многим”, сущности почему-то не были удалены</h4>
<div class="paragraph">
<p>Это ожидаемое поведение, связанное с концепции обратной и владеющей сторон связи, и тем, как с ними работает движок<em>Doctrine</em>. Когда сторона взаимосвязи “один ко многим” объявляется обратной, это означает, что Doctrine перестает воспринимать все изменения сущности, внесенные по эту сторону связи.</p>
</div>
<div class="paragraph">
<p>В качестве замены методу clear() можно использовать перебор по коллекции и установить ссылку на владеющей стороне отношения “многие к одному” в <em>NULL</em>, тем самым все сущности будут выброшены из коллекции. После этого будут выполнены соответствующие UPDATE запросы к базе данных .</p>
</div>
</div>
<div class="sect3">
<h4 id="true--36"><a class="anchor" href="#true--36"></a>6.4.4. Как добавить дополнительные столбцы к связи вида “один ко многим”?</h4>
<div class="paragraph">
<p>В качестве столбцов в определении таблицы для связи “один ко многим” допускается использовать только внешние ключи. Для добавления в такие связи дополнительных столбцов есть возможность использования внешних ключей как первичных (primary). Такая фича появилась в <em>Doctrine 2.1</em>.</p>
</div>
<div class="paragraph">
<p>Как это сделать читайте в <a href="http://www.doctrine-project.org/docs/orm/2.1/en/tutorials/composite-primary-keys.html">обучалке по составным первичным ключам</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="true--37"><a class="anchor" href="#true--37"></a>6.4.5. Можно ли осуществлять постраничную выборку из присоединенных коллекций?</h4>
<div class="paragraph">
<p>Если вам нужно выражение DQL, которое может это сделать, мы вас огорчим, нет простого способа итерации по такой коллекции с помощью оператора LIMIT.</p>
</div>
<div class="paragraph">
<p><em>Doctrine</em> не предоставляет решения “из коробки”, однако существует несколько расширений, позволяющих это сделать:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://github.com/beberlei/DoctrineExtensions">DoctrineExtensions</a></p>
</li>
<li>
<p><a href="http://github.com/whiteoctober/pagerfanta">Pagerfanta</a></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="true-fetch-joins"><a class="anchor" href="#true-fetch-joins"></a>6.4.6. Почему постраничная выборка некорректно работает с соединениями (fetch-joins)?</h4>
<div class="paragraph">
<p>Для ограничения результирующего набора данных движок постраничной выборки в <em>Doctrine</em> использует ключевое слово<em>LIMIT</em> (или его эквивалент). Однако, когда вы выполняете JOIN запрос, он не возвращает верное число записей, т.к. соединения через связи вида “один ко многим” и “многие ко многим” в качестве результирующего количества строк возвращают произведение числа строк на число связанных сущностей.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Примечание переводчика: простите, слишком сложно перевести. Оригинал:
Pagination in Doctrine uses a LIMIT clause (or vendor equivalent) to restrict the results. However when fetch-joining this is not returning the correct number of results since joining with a one-to-many or many-to-many association muliplies the number of rows by the number of associated entities.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Для решения проблемы смотрите предыдущий вопрос .</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--38"><a class="anchor" href="#true--38"></a>6.5. Наследование</h3>
<div class="sect3">
<h4 id="true-doctrine-2-2"><a class="anchor" href="#true-doctrine-2-2"></a>6.5.1. Можно ли применять наследование в Doctrine 2?</h4>
<div class="paragraph">
<p>Да, допускается наследование применительно как к единичным, так и присоединенным таблицам.</p>
</div>
<div class="paragraph">
<p>Детали описаны в соответствующей главе.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-doctrine-3"><a class="anchor" href="#true-doctrine-3"></a>6.5.2. Почему Doctrine не создает прокси объекты для иерархии классов?</h4>
<div class="paragraph">
<p>Когда в сущности создается связь с родительским классом вида “многие к одному” или “один к одному”, <em>Doctrine</em> не может определить какой из классов в действительности выступает в качестве “внешнего ключа”. Чтобы выяснить это, <em>Doctrine</em> должна выполнить <em>SQL</em> запрос для поиска этой информации в базе данных.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueentitygenerator"><a class="anchor" href="#trueentitygenerator"></a>6.6. EntityGenerator</h3>
<div class="sect3">
<h4 id="true-entitygenerator"><a class="anchor" href="#true-entitygenerator"></a>6.6.1. Почему EntityGenerator не делает ту или иную вещь?</h4>
<div class="paragraph">
<p><em>EntityGenerator</em> не является полноценным генератором кода, решающим любые задачи. Генерация кода отныне не является основным приоритетом <em>Doctrine 2</em> (в отличие от <em>Doctrine 1</em>). <em>EntityGenerator</em> конечно помогает в работе, но это не панацея.</p>
</div>
</div>
<div class="sect3">
<h4 id="true-entitygenerator-2"><a class="anchor" href="#true-entitygenerator-2"></a>6.6.2. Почему EntityGenerator некорректно работает с иерархиями?</h4>
<div class="paragraph">
<p>Дело в том, что <em>EntityGenerator</em> не может правильно угадать взаимоотношения в иерархии классов. Вот почему создание наследуемых сущностей затруднено и пока не работает как нужно. Обрабатывать подобные ситуации вам нужно будет вручную.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--39"><a class="anchor" href="#true--39"></a>6.7. Производительность</h3>
<div class="sect3">
<h4 id="true-sql-2"><a class="anchor" href="#true-sql-2"></a>6.7.1. Почему когда я обращаюсь к данным через отношение “один к одному” это всякий раз порождает SQL запрос?</h4>
<div class="paragraph">
<p>Если <em>Doctrine</em> обнаружила, что обращение к данным происходит с обратной стороны связи (inverse side), то для загрузки целевого объекта будет выполнен дополнительный запрос. Так происходит потому что нельзя определить, вдруг там вообще нет никакого объекта (стоит NULL), или там прокси-объект, а какой у него идентификатор одному богу известно.</p>
</div>
<div class="paragraph">
<p>Чтобы избежать этой проблемы, используйте запрос который сразу получает всю необходимую информацию.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-dql"><a class="anchor" href="#true-dql"></a>6.8. Язык DQL</h3>
<div class="sect3">
<h4 id="true-dql-2"><a class="anchor" href="#true-dql-2"></a>6.8.1. Что представляет собой DQL?</h4>
<div class="paragraph">
<p><em>DQL</em> это язык, очень похожий на <em>SQL</em>, имеющий ряд особенностей:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Вместо названия таблиц и столбцов он использует названия классов и их полей, абстрагируясь между бэкендом и объектной моделью.</p>
</li>
<li>
<p><em>DQL</em> применяет информацию, хранящуюся в метаданных, давая возможность использовать сокращения при написании запросов. Например, если вы не указали оператор <em>ON</em> при соединении таблиц <em>Doctrine</em> сделает это за вас.</p>
</li>
<li>
<p><em>DQL</em> добавляет некоторую функциональность, связанную с управлением объектами и преобразованием их в запросы<em>SQL</em>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Конечно, есть и недостатки:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Синтаксис его немного отличается от <em>SQL</em>, поэтому нужно четко уяснить различия.</p>
</li>
<li>
<p>Чтобы не зависеть от особенностей каждой конкретной СУБД, <em>DQL</em> реализует лишь общее подмножество <em>SQL</em>, поддерживаемое всеми продуктами.</p>
</li>
<li>
<p>В DQL нельзя использовать специфичный для конкретной СУБД функционал и различные оптимизации, пока они в явном виде не будет реализованы вами.</p>
</li>
<li>
<p>Для некоторых конструкций в <em>DQL</em> применяются вложенные <em>SELECT’ы</em>, которые в том же <em>MySQL</em> работают медленно.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="true-dql-order-by-rand"><a class="anchor" href="#true-dql-order-by-rand"></a>6.8.2. Можно ли в DQL выполнить сортировку по заданной функции (например, ORDER BY RAND())?</h4>
<div class="paragraph">
<p>Нет. Если вам нужен такой функционал, используйте низкоуровневые запросы или ищите другое решение. Имейте ввиду: начиная с 1000 записей в таблице сортировка вида <em>ORDER BY RAND()</em> выполняется крайне медленно.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basic_mapping"><a class="anchor" href="#basic_mapping"></a>7. Отображения</h2>
<div class="sectionbody">
<div class="paragraph">
<p>В главе приведено описание механизма отображений объектов и их свойств на структуру базы данных. Отображение для связей будет описано в следующей главе.</p>
</div>
<div class="sect2">
<h3 id="true--40"><a class="anchor" href="#true--40"></a>7.1. Драйвера отображений</h3>
<div class="paragraph">
<p>Любые отображения в Doctrine задаются через метаданные. Существует несколько способов для описания метаданных:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Аннотации Docblock</p>
</li>
<li>
<p>XML</p>
</li>
<li>
<p>YAML</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>В примерах к данному руководству в основном будут использоваться аннотации <em>Dockblock</em>, однако во многих из них приведены и альтернативы на <em>XML</em> и <em>YAML</em>. Более детальному описанию отображений через <em>XML</em> и <em>YAML</em> посвящены отдельные главы. Кроме того, отдельная глава будет посвящена синтаксису аннотаций.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Если вас беспокоит вопрос, какой же из описанных механизмов имеет лучшую производительность, вот ответ: все они одинаково быстро работают. После того как метаданные считаны из источника (<em>XML</em>, <em>YAML</em> или аннотаций) они тут же сохраняются в экземпляре класса Doctrine\ORM\Mapping\ClassMetadata, который, в свою очередь, хранится в специальном кеше для метаданных. Так что в итоге все они будут выполняться одинаково быстро. Если вы все же решите отказаться от кеша метаданных (что делать крайне не рекомендуется), то преимущество будет у драйвера XML, т.к. разбор этого формата осуществляется напрямую библиотекой PHP.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="true-docblock"><a class="anchor" href="#true-docblock"></a>7.2. Аннотации Docblock</h3>
<div class="paragraph">
<p>Вы, наверное, уже сталкивались с <em>Dockblock</em> аннотациями, например, когда готовили метаданные для утилит вроде<em>PHPDocumentor</em> (<em>@author</em>, <em>@link</em>, …). С их помощью в документацию можно встроить некоторые метаданные, а затем использовать их в своих целях. <em>Dockblock</em> аннотации работают также._ Doctrine 2_ обобщает концепцию аннотаций, так что их можно использовать для определения любых типов метаданных, а это позволяет определять новые аннотации. Для более эффективного использования и уменьшения вероятности их конфликта имен, в Doctrine 2 для аннотаций  используется альтернативный синтаксис, чем-то напоминающий аннотации в Java 5.</p>
</div>
<div class="paragraph">
<p>Собственно сама реализация Dockblock аннотаций заложена в пространстве имен <em>Doctrine\Common\Annotations</em>, относящуюся к пакету <em>Common</em>. Среди прочего, в <em>Dockblock</em> можно использовать пространства имен, а также вложенные аннотации. Вы все увидите в примерах. Doctrine 2 для задания метаданных, описывающих отображения, использует собственное подмножество директив.</p>
</div>
<div class="paragraph">
<p>Если вас по каким-то причинам не устраивают Dockblock аннотации, в качестве альтернативы могут быть использованы XML или YAML. Вы даже можете написать свой собственный механизм для работы с метаданными.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--41"><a class="anchor" href="#true--41"></a>7.3. Хранимые классы</h3>
<div class="paragraph">
<p>Итак, сущность это класс. Чтобы подготовить класс для работы в среде <em>ORM</em>, его необходимо превратить в сущность. Это делается с помощью специальной аннотации <em>@Entity</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
/** @Entity */
class MyPersistentClass
{
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass"&gt;
        &lt;!-- ... --&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>По умолчанию сущность будет преобразована в таблицу БД, имя которой соответствует имени класса сущности. Если вы хотите задать иное имя, можно воспользоваться аннотацией <em>@Table</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
/**
* @Entity
* @Table(name="my_persistent_class")
*/
class MyPersistentClass
{
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass" table="my_persistent_class"&gt;
        &lt;!-- ... --&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    table: my_persistent_class
    # ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>В этом примере экземпляр сущности <em>MyPersistentClass</em> будет храниться в базе данных в виде таблицы с именем<em>my_persistent_class</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="true-doctrine-4"><a class="anchor" href="#true-doctrine-4"></a>7.4. Отображения типов в Doctrine</h3>
<div class="paragraph">
<p>В <em>Doctrine</em> можно устанавливать соответствия между типами <em>PHP</em> и соответствующим им типам в базе данных. Все отображаемые типы, поставляемые с <em>Doctrine</em>, полностью совместимы с различными СУБД. Как будет показано далее в этой главе, можно создавать и пользовательские типы, совместимость которых, однако, уже не гарантируется.</p>
</div>
<div class="paragraph">
<p>Например, тип Doctrine <strong>string</strong> устанавливает соответствие между типом <em>string</em> в <em>PHP</em> и типом <em>VARCHAR</em> (или <em>VARCHAR2</em>, в зависимости от СУБД). Ниже приведено краткое описание доступных типов:</p>
</div>
<div class="paragraph">
<p><strong>string</strong>: Отображает <em>VARCHAR</em> в строку <em>PHP</em>.
<strong>integer</strong>: Отображает <em>INT</em> на целочисленный тип.
<strong>smallint</strong>: Отображает <em>SMALLINT</em> так же на целочисленный тип в <em>PHP</em>.
<strong>bigint</strong>: Отображает <em>BIGINT</em> на строку <em>PHP</em>.
<strong>boolean</strong>: Отображает булевый тип (в <em>MySQL</em> это_ TINYINT(1))_ на булевый тип в <em>PHP</em>.
<strong>decimal</strong>: Отображает <em>DECIMAL</em> на тип <em>double</em>.
<strong>date</strong>: Отображает <em>DATETIME</em> на объект типа <em>DateTime</em>.
<strong>time</strong>:  Отображает <em>TIME</em> также на объект типа <em>DateTime</em>.
<strong>datetime</strong>: Отображает типы <em>DATETIME</em> или <em>TIMESTAMP</em>  на объект <em>DateTime</em> в <em>PHP</em>.
<strong>text</strong>: Отображает тип <em>CLOB</em> на строку <em>PHP</em>.
<strong>object</strong>: Отображает тип <em>CLOB</em> на объект <em>PHP</em> с помощью сериализации (<em>serialize()</em> и <em>unserialize())</em>
<strong>array</strong>:  Отображает тип <em>CLOB</em> на объект <em>PHP</em> с помощью сериализации (<em>serialize()</em> и <em>unserialize())</em>
<strong>float</strong>: Отображает тип <em>FLOAT</em> (двойной точности) на тип <em>double</em> в <em>PHP</em>. <strong>Важно</strong>: Отображение работает только с настройками локали, в которых в качестве десятичного разделителя используется точка.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Запомните, отображаемые типы в <em>Doctrine</em> не являются ни <em>SQL</em>- ни <em>PHP</em>-типами! Они лишь устанавливают соответствие между этим двумя типами данных. Кроме того, они зависимы от регистра. Например, <em>DateTime</em> это не одно и тоже что <em>datetime</em>, который уже входит в комплект <em>Doctrine</em>.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Типы <em>DateTime</em> и <em>Object</em> всегда сравниваются по ссылке, а не по значению. Обновление их значений будет происходить в случае, если изменилась сама ссылка, поэтому объекты этих типов ведут себя подобно объектам, значение которых не может быть изменено.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>При работе с типами даты и времени предполагается, что используется стандартная временная зона, установленная функцией <a href="http://docs.php.net/manual/en/function.date-default-timezone-set.php">date_default_timezone_set()</a> или через параметр <em>date.timezone</em> в <em>php.ini</em>. При использовании в приложении различных временных зон результат может быть непредсказуемым.</p>
</div>
<div class="paragraph">
<p>Если в вашем приложении все же требуется какая-то специальная обработка временных зон, то нужно делать это вручную, перегоняя значения даты в <em>UTC</em> и обратно. В руководстве есть <a href="http://www.doctrine-project.org/docs/orm/2.1/en/cookbook/working-with-datetime.html">соответствующая статья</a>, в которой описана работа с типами даты и времени при использовании различных временных зон.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--42"><a class="anchor" href="#true--42"></a>7.5. Сопоставление свойств</h3>
<div class="paragraph">
<p>После того как класс стал сущностью, можно начать устанавливать отображения для его отдельных членов. Ниже буду описаны лишь самые простые поля со скалярными типами, вроде целых чисел и строк. Связи с другими объектами описываются в главе “Отображения связей”.</p>
</div>
<div class="paragraph">
<p>Свойство может быть отмечено как хранимое с помощью аннотации <em>@Column</em>. Эта аннотация требует указания как минимум одного атрибута&#8201;&#8212;&#8201;типа столбца, в качестве которого можно использовать любой из доступных типов <em>Doctrine</em>. Если опустить этот параметр, в качестве типа будет использован <em>string</em>, ведь он самый гибкий и универсальный.</p>
</div>
<div class="paragraph">
<p>Пример:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
/** @Entity */
class MyPersistentClass
{
    /** @Column(type="integer") */
    private $id;
    /** @Column(length=50) */
    private $name; // type defaults to string
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass"&gt;
        &lt;field name="id" type="integer" /&gt;
        &lt;field name="name" length="50" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    fields:
        id:
            type: integer
        name:
            length: 50</code></pre>
</div>
</div>
<div class="paragraph">
<p>В этом примере полю <em>id</em> соответствует столбец <em>id</em> целочисленного типа, а полю name&#8201;&#8212;&#8201;столбец <em>name</em> и тип <em>string</em>, используемый по умолчанию. Как видите, по умолчанию именам столбцов будут присвоены такие же имена, как и у полей. Задать столбцу иное имя можно с помощью атрибута <em>name</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
/** @Column(name="db_name") */
private $name;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass"&gt;
        &lt;field name="name" column="db_name" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    fields:
        name:
            length: 50
            column: db_name</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для более тонкой настройки отображений на столбцы БД можно использовать атрибуты. Вот их полный список:</p>
</div>
<div class="paragraph">
<p><strong>type</strong>: (необязательный параметр, значение по умолчанию: ‘string’) Отображаемый тип для столбца.<br>
<strong>name</strong>: (необязательный параметр, по умолчанию соответствует имени свойства) Название столбца в базе данных.<br>
<strong>length</strong>: (необязательный параметр, по умолчанию равен 255) Длина значения столбца в базе данных. (Применяется только для строковых типов).<br>
<strong>unique</strong>: (необязательный параметр, по умолчанию равен <em>FALSE</em>) Определяет, являются ли значения столбца уникальными.<br>
<strong>nullable</strong>: (необязательный параметр, по умолчанию равен <em>FALSE</em>) Могут ли значения столбца принимать пустые значения<em>(NULL)</em>.<br>
<strong>precision</strong>: (необязательный параметр, по умолчанию равен 0) Точность для неупакованных чисел с плавающей точкой. (Применяется только для столбцов типа DECIMAL.)<br>
<strong>scale</strong>:  (необязательный параметр, по-умолчанию равен 0) Задает шкалу (scale) для неупакованных чисел с плавающей точкой. (Применяется только для столбцов типа <em>DECIMAL</em>.<br></p>
</div>
</div>
<div class="sect2">
<h3 id="true--43"><a class="anchor" href="#true--43"></a>7.6. Пользовательские типы</h3>
<div class="paragraph">
<p>В <em>Doctrine</em> можно создавать свои собственные отображаемые типы. Это бывает полезно, когда не удается найти подходящий тип для конкретной задачи или вас по каким-то причинам не устраивает поведение существующих типов.</p>
</div>
<div class="paragraph">
<p>Для создания нового типа нужно наследовать класс <em>Doctrine\DBAL\Types\Type</em> и переопределить нужные вам методы. Ниже приведет шаблон такого типа:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
namespace My\Project\Types;

use Doctrine\DBAL\Types\Type;
use Doctrine\DBAL\Platforms\AbstractPlatform;

/**
 * Мой тип datatype.
*/
class MyType extends Type
{
    const MYTYPE = 'mytype'; // modify to match your type name

    public function getSqlDeclaration(array $fieldDeclaration, AbstractPlatform $platform)
    {
     // Возвращает SQL, используемый для создания столбца. Если нужен совместимый тип, используйте параметр $platform.
    }

    public function convertToPHPValue($value, AbstractPlatform $platform)
    {
     // Вызывается во время чтения значения из БД. Тут можно делать разные преобразования, в т.ч. основываясь на параметре $platform.
    }

    public function convertToDatabaseValue($value, AbstractPlatform $platform)
    {
     //  Вызывается во время записи значения в БД . Тут также можно делать разные преобразования, в т.ч. основываясь на параметре $platform .
    }

    public function getName()
    {
         return self::MYTYPE; // возвращает имя типа
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Имейте ввиду, у этой схемы есть ограничения:</p>
</div>
<div class="paragraph">
<p>Если свойство принимает значение <em>NULL</em>, метод <em>convertToDatabaseValue()</em> не будет вызываться.
Модуль <em>UnitOfWork</em> никогда не осуществляет конвертацию значений в базу данных, которые не изменились в запросе.</p>
</div>
<div class="paragraph">
<p>После того как вы реализуете свой тип, нужно сообщить о нем <em>Doctrine</em>. Это можно сделать с помощью метода<em>Doctrine\DBAL\Types\Type#addType($name, $className)</em>. Вот пример:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
// in bootstrapping code

// ...

use Doctrine\DBAL\Types\Type;

// ...

// Register my type
Type::addType('mytype', 'My\Project\Types\MyType');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видно из примера, при регистрации типа ему присваивается уникальное имя на ваш выбор, которое соответствует полному имени реализующего его класса. После регистрации, тип готов к использованию:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
class MyPersistentClass
{
    /** @Column(type="mytype") */
    private $field;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Чтобы <em>Schema-Tool</em> правильно смогла конвертировать ваш новый тип данных <em>mytype</em> в экземпляр класса <em>MyType</em>, нужно будет дополнительно зарегистрировать соответствие для этих типов:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
$conn = $em-&gt;getConnection();
$conn-&gt;getDatabasePlatform()-&gt;registerDoctrineTypeMapping('db_mytype', 'mytype');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь когда <em>Schema-Tool</em> обнаружит столбец типа <em>db_mytype</em>, она преобразует его в экземпляр класса, соответствующий доктриновскому типу <em>mytype</em>. Имейте ввиду, во избежание конфликтов каждый тип из базы данных может соответствовать только одному отображаемому типу <em>Doctrine</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--44"><a class="anchor" href="#true--44"></a>7.7. Пользовательское определение для столбца</h3>
<div class="paragraph">
<p>Для любого столбца можно задать его собственное определение с помощью атрибута <em>columnDefinition</em> аннотации <em>@Column</em>. Таким образом можно задать любое определение, следующие за именем столбца, как если бы вы это делали через SQL запрос, например, задать комментарий для столбца (и он будет сохранен в БД).</p>
</div>
<div class="paragraph">
<p>И, к сожалению, при использование этого атрибута Schema-Tool не сможет вычислять изменения в схеме базы данных.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--45"><a class="anchor" href="#true--45"></a>7.8. Идентификаторы / Первичные ключи</h3>
<div class="paragraph">
<p>Любая сущность в <em>Doctrine</em> должна иметь свой идентификатор. Задать его можно с помощью аннотации <em>@Id</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
class MyPersistentClass
{
    /** @Id @Column(type="integer") */
    private $id;
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass"&gt;

        &lt;field name="name" length="50" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    id:
        id:
            type: integer
    fields:
        name:
            length: 50</code></pre>
</div>
</div>
<div class="paragraph">
<p>Если не задано иное, идентификатор для новой сущности должен задаваться вручную. Это означает, что прежде чем передавать сущность методу <em>EntityManager#persist($entity)</em> нужно установить для нее идентификатор.</p>
</div>
<div class="paragraph">
<p>В качестве альтернативы ручной установке есть возможность генерировать значения идентификатора автоматически. Это достигается использованием аннотации <em>@GeneratedValue</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
class MyPersistentClass
{
    /**
    * @Id @Column(type="integer")
    * @GeneratedValue
    */
    private $id;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="MyPersistentClass"&gt;

            &lt;generator strategy="AUTO" /&gt;

        &lt;field name="name" length="50" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    id:
        id:
            type: integer
            generator:
                strategy: AUTO
    fields:
        name:
            length: 50</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это сообщит Doctrine, что идентификатор должен быть сгенерирован автоматически. Как именно будет происходить генерация определяется атрибутом <em>strategy</em>, по умолчанию он принимает значение <em>AUTO</em>. Это значит, что база данных сама решит как это будет происходить и использует собственный механизм. Подробности читайте далее.</p>
</div>
<div class="sect4">
<h5 id="true--46"><a class="anchor" href="#true--46"></a>Стратегии генерации идентификаторов</h5>
<div class="paragraph">
<p>В предыдущем примере показано как использовать стратегию генерации идентификатора по-умолчанию, при этом не важно какая СУБД используется. Но задать эту стратегию можно и явно, это дасть возможность использовать некторые дополнительные функции.</p>
</div>
<div class="paragraph">
<p>Ниже приведен список возможных стратегий:</p>
</div>
<div class="paragraph">
<p><strong>AUTO</strong> (по умолчанию): используется наиболее предпочтительная стратегия для текущей платформы БД. Для <em>MySQL</em>, <em>SQLite</em> и<em>MsSQL</em> это значение равно <em>IDENTITY</em>, для <em>Oracle</em> и <em>PostgreSQL</em>&#8201;&#8212;&#8201;<em>SEQUENCE</em> . Так что этот вариант самый универсальный.</p>
</div>
<div class="paragraph">
<p><strong>SEQUENCE</strong>: Для генерации идентификатора будет использована последовательность. Эта стратегия не обеспечивает полной совместимости, т.к. поддерживается только в <em>Oracle</em> и <em>PostgreSql</em>.</p>
</div>
<div class="paragraph">
<p><strong>IDENTITY</strong>: Сообщает <em>Doctrine</em> использовать специальные идентификационные столбцы, значение которых генерируется само при вставке новой записи в таблицу. Данный механизм поддерживается следующими платформами: <em>MySQL/SQLite_</em>(AUTO_INCREMENT)<em>, _MSSQL</em> <em>(IDENTITY)</em> и <em>PostgreSQL</em> <em>(SERIAL)</em>.</p>
</div>
<div class="paragraph">
<p><strong>TABLE</strong>: позволяет использовать отдельную таблицу для генерации идентификаторов. Этот механизм обеспечивает полую совместимость. <strong><strong>Но эта стратегия пока еще не реализована!</strong></strong></p>
</div>
<div class="paragraph">
<p><strong>NONE</strong>: Идентификатор не генерируется и должен быть установлен вручную. Назначать его нужно до передачи сущности методу <em>EntityManager#persist</em>. Эта стратегия будет автоматически использована при отсутствии аннотации <em>@GeneratedValue</em>.</p>
</div>
<div class="sect5">
<h6 id="true--47"><a class="anchor" href="#true--47"></a>Генератор последовательностей</h6>
<div class="paragraph">
<p>В настоящий момент генерация последовательностей возможна только для <em>Oracle</em> и <em>Postgres</em>. При использовании этой стратегии становятся доступны несколько новых параметров:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
class User
{
    /**
    * @Id
    * @GeneratedValue(strategy="SEQUENCE")
    * @SequenceGenerator(sequenceName="tablename_seq", initialValue=1, allocationSize=100)
    */
    protected $id = null;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml" data-lang="xml">&lt;doctrine-mapping&gt;
    &lt;entity name="User"&gt;

            &lt;generator strategy="SEQUENCE" /&gt;
            &lt;sequence-generator sequence-name="tablename_seq" allocation-size="100" initial-value="1" /&gt;

    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">MyPersistentClass:
    type: entity
    id:
        id:
            type: integer
            generator:
                strategy: SEQUENCE
            sequenceGenerator:
                sequenceName: tablename_seq
                allocationSize: 100
                initialValue: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>initialValue</em> задает значение, с которого начнется последовательность.</p>
</div>
<div class="paragraph">
<p>Обратите внимание на параметр <em>allocationSize, он</em> позволяет оптимизировать производительность запросов <em>INSERT</em>. Вот как это работает. Он определяет на какое количество будет увеличенная последовательность прежде чем ее следующее значение будет физически запрошено из базы данных. Если это значение больше единицы, Doctrine будет сама генерировать идентификаторы для следующих <em>allocationSizes</em> сущностей. В примере выше при значении <em>allocationSize=100</em> <em>Doctrine</em> для того, чтобы сгенерировать идентификаторы для 100 новых сущностей нужно лишь единожды обратиться к объекту <em>SEQUENCE</em> в базе данных.</p>
</div>
<div class="paragraph">
<p>Значение по умолчанию для <em>allocationSize</em> равно 10. <em>Schema-Tool</em> сама обнаруживает этот параметр и преобразовывает его в конструкцию_ INCREMENT BY_ в операторе <em>CREATE SEQUENCE</em>. Если структура базы данных была создана вручную без использования <em>Schema-Tool</em>, вам нужно проследить, чтобы <em>allocationSize</em> не превышал соответствующего ему значения в конструкции <em>INCREMENT BY</em>, иначе начнут генерироваться дубликаты. И последнее. Возможно использования параметра <em>strategy=”AUTO”</em> совместно с <em>@SequenceGenerator</em>. В этом случае генерация последовательностей будет применяться только если есть поддержка со стороны БД (для <em>Oracle</em> и <em>PostgreSQL</em>)</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="true--48"><a class="anchor" href="#true--48"></a>Составные ключи</h5>
<div class="paragraph">
<p><em>Doctrine 2</em> позволяет работать с составными первичными ключами. Правда, по сравнению с единичными ключами здесь есть пара ограничений. Так, использовать аннотацию <em>@GeneratedValue</em> можно только для простых одиночных ключей. Для составных ключей идентификатор придется генерировать вручную перед вызовом <em>EntityManager#persist()</em>.</p>
</div>
<div class="paragraph">
<p>Для создания составного ключа просто отметьте аннотацией <em>@Id</em> все поля, из которых он состоит.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--49"><a class="anchor" href="#true--49"></a>7.9. Экранирование ключевых слов</h3>
<div class="paragraph">
<p>Иногда нужно экранировать название столбца или таблицы, если оно конфликтует с ключевыми словами той или иной СУБД. Дать понять <em>Doctrine</em> что-именно следует экранировать можно, заключив название таблицы или столбца в обратные кавычки:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php
/** @Column(name="`number`", type="integer") */
private $number;</code></pre>
</div>
</div>
<div class="paragraph">
<p>После этого <em>Doctrine</em> будет будет экранировать это значение во всех <em>SQL</em> запросах.</p>
</div>
<div class="paragraph">
<p>Экранирование ключевых слов не работает для имен столбцов, используемых для соединений таблиц, а также в названиях столбцов-дискриминаторов.</p>
</div>
<div class="paragraph">
<p>Экранирование в основном предназначено для совместимости с устаревшими схемами данных. По возможности следует избегать подобных ситуаций. Не надо применять экранирование только потому, чтобы использовать нестандартные символы, вроде тире, в названиях столбцов. Кроме того, у <em>Schema-Tool</em> скорее всего будут проблемы, если экранирование используется в случаях, связанных с регистрозависимостью символов (например, в Oracle).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="association-mapping"><a class="anchor" href="#association-mapping"></a>8. Отображение связей</h2>
<div class="sectionbody">
<div class="paragraph">
<p>В этой главе приводится описание того как Doctrine работает со связанными сущностями, т.е. сущностями, между которыми существуют некоторые отношения. Для начала будет дано описание концепции прямой и обратной сторон связи. Это очень важный момент, он поможет понять принцип работы двусторонних связей. Главное, нужно усвоить, что связи могут быть одно- и дву- сторонними.</p>
</div>
<div class="sect2">
<h3 id="true--50"><a class="anchor" href="#true--50"></a>8.1. Прямая и обратная стороны связи</h3>
<div class="paragraph">
<p>При работе с двусторонними связями важно понимать суть прямой (owning) и обратной (inverse) сторон связи. Давайте начнем с простых правил:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Отношения межу сущностями могут быть двусторонними и односторонними.</p>
</li>
<li>
<p>У двустороннего отношения есть как прямая сторона (сторона владельца), так и обратная сторона.</p>
</li>
<li>
<p>У односторонних отношений есть только прямая сторона.</p>
</li>
<li>
<p>Именно прямая сторона отношения непосредственно влияет на все изменения, которые будут внесены в него в процессе работы приложения.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Для <strong>двусторонних</strong> связей справедливы следующие правила:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Обратная сторона отношения должна ссылаться на основную сторону с помощью атрибута <em>mappedBy</em>, который используется в аннотациях <em>OneToOne</em>, <em>OneToMany</em> и <em>ManyToMany</em>. Этот атрибут указывает на поле сущности, которое является “владельцем” этого отношения (и это поле расположено на “противоположном” конце связи).</p>
</li>
<li>
<p>И наоборот, прямая сторона двустороннего отношения ссылается на обратную сторону с помощью атрибута <em>inversedBy</em>, который также используется в аннотациях <em>OneToOne</em>, <em>ManyToOne</em> и <em>ManyToMany</em>. Этот атрибут указывает на поле сущности, которое является обратной стороной отношения.</p>
</li>
<li>
<p>В отношениях типа <em>OneToMany</em> и <em>ManyToOne</em> именно “Many”-сторона является прямой стороной связи, поэтому на ней нельзя использовать атрибут <em>mappedBy</em>&#8201;&#8212;&#8201;он применяется только на обратной стороне.</p>
</li>
<li>
<p>Для двусторонних отношений типа <em>OneToOne</em> прямой стороной связи является та, которая содержит соответствующий внешний ключ (он описывается аннотацией <em>@JoinColumn(s))</em>.</p>
</li>
<li>
<p>В отношениях типа <em>ManyToMany</em> любая сторона может быть прямой. <em>(Непонятно: the side that defines the @JoinTable and/or does not make use of the mappedBy attribute, thus using a default join table.)</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Несколько запутанно, правда? На самом деле все не так сложно. Самое главное, запомните:</p>
</div>
<div class="paragraph">
<p><strong>Именно прямая сторона связи определяет какие изменения в существующем отношении попадут в базу данных.</strong></p>
</div>
<div class="paragraph">
<p>Чтобы понять это, давайте вспомним как работают двусторонние отношения в мире объектов. Возьмем два объекта, между которыми существует связь. На каждой стороне этой связи существует по ссылке, каждая из которых представляет эту самую связь, но изменять эти ссылки можно независимо друг от друга. Безусловно, в правильно спроектированном приложении вся семантика двусторонних связей должна полностью контролироваться разработчиком, это его ответственность. При использовании <em>Doctrine</em> ей просто нужно указать, какую из этих ссылок нужно хранить в базе данных, а какая там хранится не должна, потому что обе ссылки хранить невозможно, это абсурд. В этом и заключается концепция прямой и обратной связей.</p>
</div>
<div class="paragraph">
<p>Когда изменения в отношение вносятся только с обратной стороны связи, <em>Doctrine</em> их проигнорирует. Поэтому для двусторонних отношений нужно всегда обновлять обе стороны (ну или с точки зрения Doctrine, хотя бы прямую сторону). Сторона владельца в двусторонней связи&#8201;&#8212;&#8201;эта та точка, в которой находится условный наблюдатель от <em>Doctrine</em> <em>(ха-ха, прямо как на выборах, прим. перев.)</em>, анализирующий связь, именно так она определяет текущее состояние связи и сам факт ее изменения (например, есть ли необходимость обновить ее в базе данных).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Концепция прямой и обратной сторон является одним из краеугольных камней технологии <em>ORM</em> и к предметной области вашего приложения она не имеет отношения. Поэтому то, что в вашем приложении понимается под стороной владельца, в терминах <em>Doctrine</em> может трактоваться иначе. И на самом деле это не играет роли.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="true--51"><a class="anchor" href="#true--51"></a>8.2. Коллекции</h3>
<div class="paragraph">
<p>В примерах к этой главе при рассмотрении связей типа “ко многим” мы будет использовать специальный интерфейс <em>Collection</em>и соответствующую ему реализацию <em>ArrayCollection</em>, которая определена в пространстве имен <em>Doctrine\Common\Collections</em>. Для чего это нужно и почему нельзя использовать простые массивы? К сожалению, массивы в <em>PHP</em>, конечно, удобны во многих случаях, но с их помощью нельзя полноценно представлять наборы объектов бизнес-логики, особенно вне контекста <em>ORM</em>. Причина состоит в том, что стандартные массивы <em>PHP</em> не могут быть прозрачно расширены для работы с продвинутыми фишками <em>ORM</em>. Классы и интерфейсы, которые лежат ближе всего к концепции коллекции, это <em>ArrayAccess</em> и <em>ArrayObject</em>, но пока экземпляры этих классов не смогут применятся в тех же конструкциях, где применяются обычные массивы (возможно, это будет сделано в <em>PHP6</em>), эффективность их будет ограничена. В принципе, можно использовать и <em>ArrayAccess</em> вместо <em>Collection</em>, ведь интерфейс <em>Collection</em> расширяет <em>ArrayAccess</em>, но это не даст вам нужной гибкости работы с коллекциями, потому что<em>API</em> <em>ArrayAccess</em> весьма примитивен (и это сделано специально), и, что более важно, нельзя будет передать эту коллекцию в всякие <em>PHP</em> функции, что делает работу с ней очень сложной.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Интерфейс <em>Collection</em> и класс <em>ArrayCollection</em>, как и все в пространстве имен <em>Doctrine</em>, не относится ни к компоненту <em>ORM</em>, ни к <em>DBAL</em>. Это просто обычный <em>PHP</em> класс,  не имеющий никаких внешних зависимостей за исключением разве что <em>PHP</em> и библиотеки <em>SPL</em>. Использование этого класса в приложении не требует его непосредственного контактирования со слоем, управляющим хранением данных (persistent layer). Класс <em>Collection</em>, как и все в модуле <em>Common</em>, не являются частью этого слоя. Вы можете вообще удалить <em>Doctrine</em>, оставив один этот класс, и весь код, его использующий продолжит нормально функционировать.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="true--52"><a class="anchor" href="#true--52"></a>8.3. Параметры отображения по-умолчанию</h3>
<div class="paragraph">
<p>Прежде чем мы начнем описывать все возможные отображения для связей, вам следует уяснить следующее. В процессе описания связей будут применяться аннотации <em>@JoinColumn</em> и <em>@JoinTable</em>. Они определяют какие столбцы в БД будут непосредственно отвечать за связь. Эти аннотации являются опциональными и имеют значения по умолчанию. Для отношения типов <em>OneToOne</em> или <em>ManyToOne</em>, используются следующие дефолтные значения:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>name: "_id"
referencedColumnName: "id"</pre>
</div>
</div>
<div class="paragraph">
<p>Давайте для примера рассмотрим такое отображение:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @OneToOne(targetEntity="Shipping") */
private $shipping;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity class="Product"&gt;
        &lt;one-to-one field="shipping" target-entity="Shipping" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">Product:
    type: entity
    oneToOne:
        shipping:
            targetEntity: Shipping</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это абсолютно тоже самое, что и следующий, более навороченный вариант:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/**
* @OneToOne(targetEntity="Shipping")
* @JoinColumn(name="shipping_id", referencedColumnName="id")
*/
private $shipping;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity class="Product"&gt;
        &lt;one-to-one field="shipping" target-entity="Shipping"&gt;
            &lt;join-column name="shipping_id" referenced-column-name="id" /&gt;
        &lt;/one-to-one&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">Product:
    type: entity
    oneToOne:
        shipping:
            targetEntity: Shipping
            joinColumn:
                name: shipping_id
                referencedColumnName: id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Конструкция <em>@JoinTable</em>, используемая для отображения связей <em>ManyToMany</em> имеет аналогичные значения по умолчанию:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">class User
{
    //...
    /** @ManyToMany(targetEntity="Group") */
    private $groups;
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity class="User"&gt;
        &lt;many-to-many field="groups" target-entity="Group" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToMany:
        groups:
            targetEntity: Group</code></pre>
</div>
</div>
<div class="paragraph">
<p>В более полной нотации это выглядит так:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">class User
{
    //...
    /**
    * @ManyToMany(targetEntity="Group")
    * @JoinTable(name="User_Group",
    * joinColumns={@JoinColumn(name="User_id", referencedColumnName="id")},
    * inverseJoinColumns={@JoinColumn(name="Group_id", referencedColumnName="id")}
    * )
    */
    private $groups;
    //...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity class="User"&gt;
        &lt;many-to-many field="groups" target-entity="Group"&gt;
            &lt;join-table name="User_Group"&gt;
                &lt;join-columns&gt;
                    &lt;join-column id="User_id" referenced-column-name="id" /&gt;
                &lt;/join-columns&gt;

                    &lt;join-column id="Group_id" referenced-column-name="id" /&gt;

            &lt;/join-table&gt;
        &lt;/many-to-many&gt;
    &lt;/entity&gt;
 &lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToMany:
        groups:
            targetEntity: Group
            joinTable:
                name: User_Group
                joinColumns:
                    User_id:
                        referencedColumnName: id
                inverseJoinColumns:
                    Group_id:
                        referencedColumnName: id</code></pre>
</div>
</div>
<div class="paragraph">
<p>В этом варианте имя таблицы, используемой для связи по умолчанию соответствует неполным именам участвующих в отношении классов, разделенных символом подчеркивания. Имена столбцов в этой таблице по умолчанию складывается из неполного имени целевого класса с суффиксом “<strong>_id</strong>“. Параметр <strong>referencedColumnName</strong> по умолчанию всегда равен “<strong>id</strong>“, это справедливо как для отношений “один к одному”, так и для “многие к одному”.</p>
</div>
<div class="paragraph">
<p>Если вас устраивают значения по-умолчанию можно не писать лишнего кода.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--53"><a class="anchor" href="#true--53"></a>8.4. Инициализация коллекций</h3>
<div class="paragraph">
<p>При работе с полями, содержащими коллекции сущностей стоит быть внимательным. Допустим, у нас есть сущность <em>User</em>, которая содержит коллекцию групп:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    /** @ManyToMany(targetEntity="Group") */
    private $groups;

    public function getGroups()
    {
        return $this-&gt;groups;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Если рассматривать этот код отдельно, то видно, что поле <em>$groups</em> является только экземпляром класса <em>Doctrine\Common\Collections\Collection</em>, и пользователь может запросить его с помощью соответствующего метода. Однако,  сразу после создания объекта <em>User</em> поле <em>$groups</em>, очевидно, будет иметь значение <em>NULL</em>.</p>
</div>
<div class="paragraph">
<p>Такие поля нужно заранее инициализировать в конструкторе пустыми объектами <em>ArrayCollection</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

use Doctrine\Common\Collections\ArrayCollection;

/** @Entity */
class User
{
    /** @ManyToMany(targetEntity="Group") */
    private $groups;

    public function _construct()
    {
        $this-&gt;groups = new ArrayCollection();
    }

    public function getGroups()
    {
        return $this-&gt;groups;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Вот. И теперь следующий код будет нормально работать даже если сущность еще не связана с менеджером <em>EntityManager</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

$group = $entityManager-&gt;find('Group', $groupId);
$user = new User();
$user-&gt;getGroups()-&gt;add($group);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-runtime-development"><a class="anchor" href="#true-runtime-development"></a>8.5. Валидация отображений в различных средах (Runtime и Development)</h3>
<div class="paragraph">
<p>По причинам, связанным с производительностью <em>Doctrine 2</em> не производит полную валидацию связи, т.е. проверку на предмет того правильно ли она мэппится на схему базы данных. Нужно самостоятельно проверять корректно ли настроена та или иная связь. Сделать это через командную строку:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ doctrine orm:validate-schema</pre>
</div>
</div>
<div class="paragraph">
<p>Либо выполнить валидацию вручную:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

use Doctrine\ORM\Tools\SchemaValidator;

$validator = new SchemaValidator($entityManager);
$errors = $validator-&gt;validateMapping();

if (count($errors) &gt; 0) {
    // Lots of errors!
    echo implode("\n\n", $errors);
}</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Если с отображением что-то не так, массив <em>$errors</em> будет содержать сообщения об ошибках. Единственный параметр, валидация которого не производится, это <em>referencedColumnName</em>. Он должен всегда равняться первичному ключу, иначе <em>Doctrine</em> вообще не будет работать.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Основная ошибка заключается в использовании обратного слеша в полном имени класса. Когда вы записываете это имя в виде строки (например в настройках отображения) обратный слеш в начале строки нужно убрать. Для обратной совместимости <em>PHP</em> делает это с помощью функции <em>get_class()</em> или с помощью механизма рефлексии.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="true--54"><a class="anchor" href="#true--54"></a>8.6. Отношения “один к одному”, односторонние</h3>
<div class="paragraph">
<p>Односторонние связи типа “один к одному” являются, наверное, самыми распространенными. Вот вам пример: сущность<em>Product</em> (товар) имеет один объект <em>Shipping</em> (отгрузка товара). При этом в <em>Shipping</em> нет ссылки обратно на <em>Product</em>, поэтому отношение и называется односторонним: <em>Product &#8594; Shipping</em>.</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @Entity */
class Product
{
    // ...

   /**
    * @OneToOne(targetEntity="Shipping")
    * @JoinColumn(name="shipping_id", referencedColumnName="id")
    */
    private $shipping;

   // ...
}

/** @Entity */
class Shipping
{
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity class="Product"&gt;
        &lt;one-to-one field="shipping" target-entity="Shipping"&gt;
            &lt;join-column name="shipping_id" referenced-column-name="id" /&gt;
        &lt;/one-to-one&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">Product:
    type: entity
    oneToOne:
        shipping:
            targetEntity: Shipping
            joinColumn:
                name: shipping_id
                referencedColumnName: id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию @JoinColumn здесь не обязательно, т.к. значение по умолчанию дадут то же результат.</p>
</div>
<div class="paragraph">
<p>Итоговая схема MySQL будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE Product (
    id INT AUTO_INCREMENT NOT NULL,
    shipping_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE Shipping (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE Product ADD FOREIGN KEY (shipping_id) REFERENCES Shipping(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--55"><a class="anchor" href="#true--55"></a>8.7. Отношения “один к одному”, двусторонние</h3>
<div class="paragraph">
<p>В качестве примера возьмем отношения между объектами <em>Customer</em> (заказчик) и <em>Cart</em> (корзина). Смотрите, у <em>Cart</em> есть обратная ссылка на <em>Customer</em>, поэтому эта связь является двусторонней:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @Entity */
class Customer
{
    // ...

   /**
    * @OneToOne(targetEntity="Cart", mappedBy="customer")
    */
    private $cart;

   // ...
}

/** @Entity */
class Cart
{
    // ...

   /**
    * @OneToOne(targetEntity="Customer", inversedBy="cart")
    * @JoinColumn(name="customer_id", referencedColumnName="id")
    */
    private $customer;

   // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="Customer"&gt;
        &lt;one-to-one field="cart" target-entity="Cart" mapped-by="customer" /&gt;
    &lt;/entity&gt;
    &lt;entity name="Cart"&gt;
        &lt;one-to-one field="customer" target-entity="Customer" inversed-by="cart"&gt;
            &lt;join-column name="customer_id" referenced-column-name="id" /&gt;
        &lt;/one-to-one&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">Customer:
    oneToOne:
        cart:
            targetEntity: Cart
            mappedBy: customer
Cart:
    oneToOne:
        customer:
            targetEntity: Customer
            inversedBy: cart
            joinColumn:
                name: customer_id
                referencedColumnName: id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию <em>@JoinColumn</em> здесь не обязательно, т.к. значение по-умолчанию дадут то же результат.</p>
</div>
<div class="paragraph">
<p>Итоговая схема <em>MySQL</em> будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE Cart (
    id INT AUTO_INCREMENT NOT NULL,
    customer_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE Customer (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE Cart ADD FOREIGN KEY (customer_id) REFERENCES Customer(id);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Посмотрите как определен внешний ключ на прямой стороне отношения&#8201;&#8212;&#8201;таблице <em>Cart</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="true--56"><a class="anchor" href="#true--56"></a>8.8. Отношения “один к одному” со ссылкой на себя же</h3>
<div class="paragraph">
<p>Такие отношения в <em>Doctrine</em> реализовываются весьма просто:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @Entity */
class Student
{
    // ...

   /**
    * @OneToOne(targetEntity="Student")
    * @JoinColumn(name="mentor_id", referencedColumnName="id")
    */
    private $mentor;

   // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию <em>@JoinColumn</em> здесь не обязательно, т.к. значение по умолчанию дадут то же результат.</p>
</div>
<div class="paragraph">
<p>Итоговая схема <em>MySQL</em> будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE Student (
    id INT AUTO_INCREMENT NOT NULL,
    mentor_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE Student ADD FOREIGN KEY (mentor_id) REFERENCES Student(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-jointable"><a class="anchor" href="#true-jointable"></a>8.9. Отношения “один ко многим”, односторонние, с использованием @JoinTable</h3>
<div class="paragraph">
<p>Односторонние связи типа “один ко многим” можно определять через подсоединяемую таблицу. С точки зрения Doctrine это выглядит как одностороннее отношение “многие ко многим”, где у одной из подсоединяемых колонок указан флаг уникальности, это и обеспечивает функционирование подобно отношениям “один ко многим”. Следующий пример описывает сказанное:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    // ...

    /**
     * @ManyToMany(targetEntity="Phonenumber")
     * @JoinTable(name="users_phonenumbers",
     * joinColumns={@JoinColumn(name="user_id", referencedColumnName="id")},
     * inverseJoinColumns={@JoinColumn(name="phonenumber_id", referencedColumnName="id", unique=true)}
     * )
     */
    private $phonenumbers;

    public function _construct() {
        $this-&gt;phonenumbers = new \Doctrine\Common\Collections\ArrayCollection();
    }

    // ...
}

/** @Entity */
class Phonenumber
{
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="User"&gt;
        &lt;many-to-many field="phonenumbers" target-entity="Phonenumber"&gt;
            &lt;join-table name="users_phonenumbers"&gt;
                &lt;join-columns&gt;
                    &lt;join-column name="user_id" referenced-column-name="id" /&gt;
                &lt;/join-columns&gt;

                    &lt;join-column name="phonenumber_id" referenced-column-name="id" unique="true" /&gt;

            &lt;/join-table&gt;
        &lt;/many-to-many&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToMany:
        phonenumbers:
            targetEntity: Phonenumber
            joinTable:
                name: users_phonenumbers
                joinColumns:
                    user_id:
                    referencedColumnName: id
                inverseJoinColumns
                    phonenumber_id:
                        referencedColumnName: id
                        unique: true</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Описанные отношения работают только с использованием аннотации <em>@ManyToMany</em> совместно с ограничителем <em>unique.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Итоговая схема <em>MySQL</em> будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE USER (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE users_phonenumbers (
    user_id INT NOT NULL,
    phonenumber_id INT NOT NULL,
    UNIQUE INDEX users_phonenumbers_phonenumber_id_uniq (phonenumber_id),
    PRIMARY KEY(user_id, phonenumber_id)
) ENGINE = InnoDB;

CREATE TABLE Phonenumber (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE users_phonenumbers ADD FOREIGN KEY (user_id) REFERENCES USER(id);
ALTER TABLE users_phonenumbers ADD FOREIGN KEY (phonenumber_id) REFERENCES Phonenumber(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--57"><a class="anchor" href="#true--57"></a>8.10. Отношения “многие к одному”, односторонние</h3>
<div class="paragraph">
<p>Отношение типа “многие к одному” определяются следующим образом:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">/** @Entity */
class User
{
    // ...

    /**
     * @ManyToOne(targetEntity="Address")
     * @JoinColumn(name="address_id", referencedColumnName="id")
     */
    private $address;
}

/** @Entity */
class Address
{
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="User"&gt;
       &lt;many-to-one field="address" target-entity="Address" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToOne:
        address:
            targetEntity: Address</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию <em>@JoinColumn</em> здесь не обязательно, т.к. по умолчанию и так будут использоваться колонки <em>address_id</em> и <em>id</em>. Можно их и не указывать.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Итоговая схема MySQL будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE USER (
    id INT AUTO_INCREMENT NOT NULL,
    address_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE Address (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE USER ADD FOREIGN KEY (address_id) REFERENCES Address(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--58"><a class="anchor" href="#true--58"></a>8.11. Отношения “один ко многим”, двусторонние</h3>
<div class="paragraph">
<p>Двусторонние отношения вида “один ко многим” весьма распространены. Следующий пример показывает их реализацию на примере классов <em>Product</em> и <em>Feature</em>:</p>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="Product"&gt;
        &lt;one-to-many field="features" target-entity="Feature" mapped-by="product" /&gt;
    &lt;/entity&gt;
    &lt;entity name="Feature"&gt;
        &lt;many-to-one field="product" target-entity="Product" inversed-by="features"&gt;
            &lt;join-column name="product_id" referenced-column-name="id" /&gt;
        &lt;/many-to-one&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию_ @JoinColumn_ здесь не обязательно, т.к. значение по умолчанию дадут то же результат.</p>
</div>
<div class="paragraph">
<p>Итоговая схема <em>MySQL</em> будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE Product (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE Feature (
    id INT AUTO_INCREMENT NOT NULL,
    product_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE Feature ADD FOREIGN KEY (product_id) REFERENCES Product(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--59"><a class="anchor" href="#true--59"></a>8.12. Отношения “один ко многим” со ссылкой на себя</h3>
<div class="paragraph">
<p>Пример показывает как настроить иерархию объектов Category с помощью отношения, ссылающегося на само себя. Этот подход позволяет реализовать иерархию категорий, в терминах БД называемой “списком смежных вершин”.</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class Category
{
    // ...
    /**
     * @OneToMany(targetEntity="Category", mappedBy="parent")
     */
    private $children;

    /**
     * @ManyToOne(targetEntity="Category", inversedBy="children")
     * @JoinColumn(name="parent_id", referencedColumnName="id")
     */
    private $parent;
    // ...

    public function _construct() {
        $this-&gt;children = new \Doctrine\Common\Collections\ArrayCollection();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="Category"&gt;
        &lt;one-to-many field="children" target-entity="Category" mapped-by="parent" /&gt;
        &lt;many-to-one field="parent" target-entity="Category" inversed-by="children" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">Category:
    type: entity
    oneToMany:
        children:
            targetEntity: Category
            mappedBy: parent
    manyToOne:
        parent:
            targetEntity: Category
            inversedBy: children</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание, что использовать аннотацию <em>@JoinColumn</em> здесь не обязательно, т.к. значение по умолчанию дадут то же результат.</p>
</div>
<div class="paragraph">
<p>Итоговая схема <em>MySQL</em> будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE Category (
    id INT AUTO_INCREMENT NOT NULL,
    parent_id INT DEFAULT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE Category ADD FOREIGN KEY (parent_id) REFERENCES Category(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--60"><a class="anchor" href="#true--60"></a>8.13. Отношения “многие ко многим”, односторонние</h3>
<div class="paragraph">
<p>В реальных преложениях отношения типа “многие ко многим” встречаются реже. Следующий пример показывает как они определяются на примере сущностей <em>User</em> и <em>Group</em>:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    // ...

    /**
     * @ManyToMany(targetEntity="Group")
     * @JoinTable(name="users_groups",
     * joinColumns={@JoinColumn(name="user_id", referencedColumnName="id")},
     * inverseJoinColumns={@JoinColumn(name="group_id", referencedColumnName="id")}
     * )
     */
    private $groups;

    // ...

    public function _construct() {
        $this-&gt;groups = new \Doctrine\Common\Collections\ArrayCollection();
    }
}

/** @Entity */
class Group
{
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="User"&gt;
        &lt;many-to-many field="groups" target-entity="Group"&gt;
            &lt;join-table name="users_groups"&gt;
                &lt;join-columns&gt;
                    &lt;join-column name="user_id" referenced-column-name="id" /&gt;
                &lt;/join-columns&gt;

                    &lt;join-column name="group_id" referenced-column-name="id" /&gt;

            &lt;/join-table&gt;
        &lt;/many-to-many&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToMany:
        groups:
            targetEntity: Group
            joinTable:
                name: users_groups
                joinColumns:
                    user_id:
                        referencedColumnName: id
                inverseJoinColumns:
                    group_id:
                        referencedColumnName: id</code></pre>
</div>
</div>
<div class="paragraph">
<p>Итоговая схема MySQL будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE USER (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE users_groups (
    user_id INT NOT NULL,
    group_id INT NOT NULL,
    PRIMARY KEY(user_id, group_id)
) ENGINE = InnoDB;

CREATE TABLE GROUP (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

ALTER TABLE users_groups ADD FOREIGN KEY (user_id) REFERENCES USER(id);
ALTER TABLE users_groups ADD FOREIGN KEY (group_id) REFERENCES GROUP(id);</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Так почему же такие связи реже встречаются в повседневной жизни? Все дело в том, что часто вам нужно привязать к связи какие-то дополнительные атрибуты, для чего под эту связь потребуется создать отдельный класс (связь<em>ManyToMany</em> это сделать не позволяет, здесь лишь будет создана таблица с двумя столбцами.) И, как следствие, связь “многие ко многим” в явном виде исчезает, а вместо нее появятся уже две связи&#8201;&#8212;&#8201;“один ко многим” и “многие к одному”, связывающие между собой три отдельных класса.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="true--61"><a class="anchor" href="#true--61"></a>8.14. Отношения “многие ко многим”, двусторонние</h3>
<div class="paragraph">
<p>Эти отношения аналогичны описанным выше, но они двусторонние:</p>
</div>
<div class="paragraph">
<p><strong>PHP</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    // ...

    /**
     * @ManyToMany(targetEntity="Group", inversedBy="users")
     * @JoinTable(name="users_groups")
     */
    private $groups;

    public function _construct() {
        $this-&gt;groups = new \Doctrine\Common\Collections\ArrayCollection();
    }

    // ...
}

/** @Entity */
class Group
{
    // ...
    /**
     * @ManyToMany(targetEntity="User", mappedBy="groups")
     */
    private $users;

    public function _construct() {
        $this-&gt;users = new \Doctrine\Common\Collections\ArrayCollection();
    }

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>XML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-XML" data-lang="XML">&lt;doctrine-mapping&gt;
    &lt;entity name="User"&gt;
        &lt;many-to-many field="groups" inversed-by="users"&gt;
            &lt;join-table name="users_groups"&gt;
                &lt;join-columns&gt;
                    &lt;join-column name="user_id" referenced-column-name="id" /&gt;
                &lt;/join-columns&gt;

                    &lt;join-column name="group_id" referenced-column-name="id" /&gt;

            &lt;/join-table&gt;
        &lt;/many-to-many&gt;
    &lt;/entity&gt;

    &lt;entity name="Group"&gt;
        &lt;many-to-many field="users" mapped-by="groups" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>YAML</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-YAML" data-lang="YAML">User:
    type: entity
    manyToMany:
        groups:
            targetEntity: Group
            inversedBy: users
            joinTable:
                name: users_groups
                joinColumns:
                    user_id:
                        referencedColumnName: id
                inverseJoinColumns:
                    group_id:
                        referencedColumnName: id

Group:
    type: entity
    manyToMany:
        users:
            targetEntity: User
            mappedBy: groups</code></pre>
</div>
</div>
<div class="paragraph">
<p>Итоговая схема базы данных будет такая же как в предыдущем примере для односторонней связи.</p>
</div>
<div class="sect4">
<h5 id="true-picking-owning-and-inverse-side"><a class="anchor" href="#true-picking-owning-and-inverse-side"></a>??&lt;Picking Owning and Inverse Side&gt;</h5>
<div class="paragraph">
<p>Для связей “многие ко многим” можно указать какая сущность представляет прямую, а какая обратную сторону связи. Чтобы вам как разработчкику было проще определиться с тем, какая из сущностей больше подходит на роль прямой стороны связи, используйте следующее правило. Просто ответьте на вопрос, какая из сущностей отвечает за управление соединением, и это и будет прямая сторона.</p>
</div>
<div class="paragraph">
<p>Для примера возьмем две сущности: <em>Article</em> (статья) и <em>Tag</em> (тег). Всякий раз, когда вам нужно связать эти две сущности, в большинстве случаев именно <em>Article</em> будет отвечать за эту связь. И всякий раз при создании новой статьи, вам нужно буде соединить ее с существующими или новыми тегами. HTML-форма, отвечающая за создание статей вероятно так и работает, позволяя непосредственно указывать теги. Вот почему в качестве прямой стороны нужно выбрать <em>Article</em>, ваш код в этом случае будет более понятен, т.к. вы создаете модель в <em>Doctrine</em> в соответствии с тем, как эта связь функционирует в реальной жизни:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

class Article
{
    private $tags;

    public function addTag(Tag $tag)
    {
        $tag-&gt;addArticle($this); // synchronously updating inverse side
        $this-&gt;tags[] = $tag;
    }
}

class Tag
{
    private $articles;

    public function addArticle(Article $article)
    {
       $this-&gt;articles[] = $article;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это позволит разместить механизм добавления тегов на Article-стороне связи:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

$article = new Article();
$article-&gt;addTag($tagA);
$article-&gt;addTag($tagB);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true--62"><a class="anchor" href="#true--62"></a>8.15. Отношения “многие ко многим” со ссылкой на себя</h3>
<div class="paragraph">
<p>Да, они могу ссылаться на сами себя. Типичный сценарий выглядит так: у пользователя <em>User</em> есть друзья, при этом целевая сущность этого отношения это тоже <em>User</em>, таким образом имеет место ссылка на самого себя. В этом примере используется двусторонняя связь: у <em>User</em> есть поле <em>$friendsWithMe</em> и поле <em>$myFriends</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    // ...

    /**
     * @ManyToMany(targetEntity="User", mappedBy="myFriends")
     */
    private $friendsWithMe;

    /**
     * @ManyToMany(targetEntity="User", inversedBy="friendsWithMe")
     * @JoinTable(name="friends",
     * joinColumns={@JoinColumn(name="user_id", referencedColumnName="id")},
     * inverseJoinColumns={@JoinColumn(name="friend_user_id", referencedColumnName="id")}
     * )
     */
    private $myFriends;

    public function _construct() {
        $this-&gt;friendsWithMe = new \Doctrine\Common\Collections\ArrayCollection();
        $this-&gt;myFriends = new \Doctrine\Common\Collections\ArrayCollection();
    }

    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Схема БД:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">CREATE TABLE USER (
    id INT AUTO_INCREMENT NOT NULL,
    PRIMARY KEY(id)
) ENGINE = InnoDB;

CREATE TABLE friends (
    user_id INT NOT NULL,
    friend_user_id INT NOT NULL,
    PRIMARY KEY(user_id, friend_user_id)
) ENGINE = InnoDB;

ALTER TABLE friends ADD FOREIGN KEY (user_id) REFERENCES USER(id);
ALTER TABLE friends ADD FOREIGN KEY (friend_user_id) REFERENCES USER(id);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="true-to-many"><a class="anchor" href="#true-to-many"></a>8.16. Сортировка коллекций в связях “To-Many”</h3>
<div class="paragraph">
<p>Во многих случаях при запросе сущности из БД вам нужно получать коллекции в уже отсортированном виде. Чтобы сделать это нужно определить для коллекции аннотацию <em>@OrderBy</em>. В этой аннотации указывается специальное DQL-выражение, которое будет добавляться ко всем запросам к этой коллекции. Описать <em>@OrderBy</em> для аннотаций <em>@OneToMany</em> или <em>@ManyToMany</em>можно так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-php" data-lang="php">&lt;?php

/** @Entity */
class User
{
    // ...

    /**
     * @ManyToMany(targetEntity="Group")
     * @OrderBy({"name" = "ASC"})
     */
    private $groups;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>DQL должен состоять только из “чистых” имен полей без кавычек, а также опционального параметра ASC/DESC. Если нужна сортировка по нескольким полям, они разделяются запятой. Имена столбцов в этом выражении должны существовать в классе<em>targetEntity</em>, который описывается в аннотациях <em>@ManyToMany</em> и <em>@OneToMany</em>.</p>
</div>
<div class="paragraph">
<p>Семантику использования этой функции можно описать так:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>@OrderBy</em> выступает в роли неявного выражения <em>ORDER BY</em>, который будет явно добавляться к запросу при выборке набора.</p>
</li>
<li>
<p>Все такие коллекции всегда будут загружаться уже упорядоченными.</p>
</li>
<li>
<p>Чтоб сильно не влиять на работу БД этот неявный <em>ORDER BY</em> добавляется к запросу только если коллекция выбирается явно с подсоединением (fetch joined).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Для вышеприведенного примера следующий DQL-запрос не будет добавлять <em>ORDER BY</em>, потому что сущность <strong>g</strong> здесь не присоединяется к запросу явно:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">SELECT u FROM USER u JOIN u.groups g WHERE SIZE(g) &gt; 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Однако следующий пример:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">SELECT u, g FROM USER u JOIN u.groups g WHERE u.id = 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Будет автоматически переписан в:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">SELECT u, g FROM USER u JOIN u.groups g WHERE u.id = 10 ORDER BY g.name ASC</code></pre>
</div>
</div>
<div class="paragraph">
<p>И поменять порядок, явно указав его в DQL, нельзя:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">SELECT u, g FROM USER u JOIN u.groups g WHERE u.id = 10 ORDER BY g.name DESC</code></pre>
</div>
</div>
<div class="paragraph">
<p>Это будет автоматически переписано в:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql" data-lang="sql">SELECT u, g FROM USER u JOIN u.groups g WHERE u.id = 10 ORDER BY g.name DESC, g.name ASC</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2016-01-08 01:50:17 RTZ
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>